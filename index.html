<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Калькулятор печати</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<body>

<!-- Тело калькулятора -->

    <div class="container">
        <h1>Калькулятор печати</h1>

        <div class="products-container">
            <div class="products-header">
                <h2 class="section-title"><i class="fas fa-cube"></i> Мои изделия</h2>
            </div>

            <div class="products-list" id="productsList">
                <div class="empty-list-message">Добавьте первое изделие</div>
            </div>

            <div class="total-cost-section">
                <div class="total-cost-label"><i class="fas fa-receipt"></i> Общая стоимость заказа:</div>
                <div class="total-cost-value" id="totalOrderCost">0 руб.</div>
            </div>
        </div>

        <div class="main-content">
            <div class="form-container">
                <h2 class="section-title"><i class="fas fa-calculator"></i> Параметры изделия</h2>

                <form id="calculatorForm">
                    <input type="hidden" id="productId" value="">
                    
                    <div class="form-group">
                        <label for="productType"><i class="fas fa-tags"></i> Тип изделия:</label>
                        <select id="productType" required>
                            <option value="sheet" selected>Листовая печать</option>
                            <option value="visiting">Визитки</option>
                            <option value="booklet">Лифлеты</option>
                            <option value="book">Книги</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="productName"><i class="fas fa-tag"></i> Название изделия:</label>
                        <input type="text" id="productName" placeholder="Введите название изделия" value="Листовая печать 1">
                    </div>

                    <div class="form-group not-for-visiting">
                        <label for="colorType"><i class="fas fa-palette"></i> Красочность:</label>
                        <select id="colorType" required>
                            <option value="" disabled selected>Выберите тип красочности</option>
                            <option value="1">4+0 (односторонняя цветная)</option>
                            <option value="2">4+4 (двусторонняя цветная)</option>
                            <option value="3">1+0 (односторонняя черно-белая)</option>
                            <option value="4">1+1 (двусторонняя черно-белая)</option>
                            <option value="5">4+1 (смешанная печать)</option>
                        </select>
                    </div>

                    <div class="form-group visiting-card-only">
                        <label for="visitingColorType"><i class="fas fa-palette"></i> Красочность визиток:</label>
                        <select id="visitingColorType">
                            <option value="1">4+0 (односторонняя цветная)</option>
                            <option value="5">4+1 (смешанная печать)</option>
                            <option value="2">4+4 (двусторонняя цветная)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="quantity"><i class="fas fa-copy"></i> Количество:</label>
                        <input type="number" id="quantity" min="1" value="100" required placeholder="Введите количество">
                        <div id="quantityError" class="error-message">Пожалуйста, введите корректное число</div>
                        <div class="visiting-card-only info-text">Минимальное количество для визиток: 96 шт.</div>
                    </div>

                    <div class="form-group visiting-card-only">
                        <label><i class="fas fa-copy"></i> Количество визиток:</label>
                        <div class="quantity-control">
                            <button type="button" class="quantity-btn" id="visitingQuantityMinus">-</button>
                            <input type="number" id="visitingQuantity" class="quantity-input" value="96" min="96" step="24" required>
                            <button type="button" class="quantity-btn" id="visitingQuantityPlus">+</button>
                        </div>
                        <div class="info-text">Изменяется с шагом 24, минимум 96 шт.</div>
                    </div>

                    <div class="form-group not-for-visiting">
                        <label for="formatType"><i class="fas fa-expand-alt"></i> Размер изделия:</label>
                        <select id="formatType" required>
                            <option value="" disabled selected>Выберите формат</option>
                            <option value="1">А3 (297х420 мм)</option>
                            <option value="2">А4 (210х297 мм)</option>
                            <option value="3" selected>А5 (148х210 мм)</option>
                            <option value="4">А6 (105х148 мм)</option>
                            <option value="5">А7 (74Х105 мм)</option>
                            <option value="6">А8 (52Х74 мм)</option>
                        </select>

                        <div class="size-inputs">
                            <div>
                                <label for="width"><i class="fas fa-arrows-alt-h"></i> Ширина (мм):</label>
                                <input type="number" id="width" placeholder="Введите ширину">
                            </div>
                            <div>
                                <label for="height"><i class="fas fa-arrows-alt-v"></i> Высота (мм):</label>
                                <input type="number" id="height" placeholder="Введите высоту">
                            </div>
                        </div>
                    </div>

                    <div class="form-group not-for-visiting">
                        <label for="paperType"><i class="fas fa-file-alt"></i> Тип бумаги:</label>
                        <select id="paperType" required>
                            <optgroup label="Офисная">
                                <option value="1">ВХИ</option>
                            </optgroup>
                            <optgroup label="Мелованная">
                                <option value="2" selected>90-115 г/м²</option>
                                <option value="3">130-170 г/м²</option>
                                <option value="4">200-250 г/м²</option>
                                <option value="5">300 г/м²</option>
                            </optgroup>
                            <optgroup label="Дизайнерская">
                                <option value="6">Картон 250-270 г/м²</option>
                                <option value="7">Лён</option>
                                <option value="8">Жемчуг</option>
                                <option value="9">Самоклейка</option>
                            </optgroup>
                            <optgroup label="Color copy">
                                <option value="10">120 г/м²</option>
                                <option value="11">160 г/м²</option>
                                <option value="12">200 г/м²</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group visiting-card-only">
                        <label for="visitingPaperType"><i class="fas fa-file-alt"></i> Тип бумаги для визиток:</label>
                            <select id="visitingPaperType">
                                <option value="10">300 г/м²</option>
                                <option value="14">Лён</option>
                                <option value="15">Жемчуг</option>
                            </select>
                    </div>

                    <!-- Добавляем секцию параметров буклета -->
                    <div class="form-group booklet-only">
                        <label for="bookletColorType"><i class="fas fa-palette"></i> Красочность лифлетов:</label>
                        <select id="bookletColorType">
                            <option value="1">4+0 (односторонняя цветная)</option>
                            <option value="2" selected>4+4 (двусторонняя цветная)</option>
                            <option value="3">1+0 (односторонняя черно-белая)</option>
                            <option value="4">1+1 (двусторонняя черно-белая)</option>
                            <option value="5">4+1 (смешанная печать)</option>
                        </select>
                    </div>

                    <div class="form-group booklet-only">
                        <label for="bookletQuantity"><i class="fas fa-copy"></i> Количество лифлетов:</label>
                        <input type="number" id="bookletQuantity" min="1" value="100" required placeholder="Введите количество">
                    </div>

                    <div class="form-group booklet-only">
                        <label for="bookletPaperType"><i class="fas fa-file-alt"></i> Тип бумаги для лифлетов:</label>
                        <select id="bookletPaperType">
                            <optgroup label="Офисная">
                                <option value="1">ВХИ</option>
                            </optgroup>
                            <optgroup label="Мелованная">
                                <option value="2" selected>90-115 г/м²</option>
                                <option value="3">130-170 г/м²</option>
                                <option value="4">200-250 г/м²</option>
                            </optgroup>
                            <optgroup label="Дизайнерская">
                                <option value="7">Лён</option>
                                <option value="8">Жемчуг</option>
                                <option value="9">Самоклейка</option>
                            </optgroup>
                            <optgroup label="Color copy">
                                <option value="10">120 г/м²</option>
                                <option value="11">160 г/м²</option>
                                <option value="12">200 г/м²</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group booklet-only">
                        <label><i class="fas fa-expand-alt"></i> Размер лифлетов:</label>
                        <div style="display: flex; gap: 20px; margin-top: 10px;">
                            <label class="checkbox-container">
                                А3 (297×420 мм)
                                <input type="radio" name="bookletSize" value="A3" checked>
                                <span class="checkmark" style="border-radius: 50%;"></span>
                            </label>
                            <label class="checkbox-container">
                                А4 (210×297 мм) 
                                <input type="radio" name="bookletSize" value="A4">
                                <span class="checkmark" style="border-radius: 50%;"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Обновляем секцию дополнительной обработки -->
                    <div class="postprint-section booklet-only">
                        <h3 class="section-title"><i class="fas fa-tools"></i> Дополнительная обработка лифлетов</h3>
                        
                        <!-- Добавляем тиснение -->
                        <div class="checkbox-group">
                            <label class="checkbox-container">
                                Тиснение лифлетов
                                <input type="checkbox" id="bookletEmbossingRequired">
                                <span class="checkmark"></span>
                            </label>
                        </div>

                        <div id="bookletEmbossingOptions" class="additional-options">
                            <div class="form-group">
                                <label for="bookletEmbossingHits"><i class="fas fa-hammer"></i> Количество ударов:</label>
                                <div class="input-with-button">
                                    <input type="number" id="bookletEmbossingHits" min="1" value="20" placeholder="Минимум 20 ударов">
                                    <button type="button" class="all-button" id="bookletEmbossingAllButton">все</button>
                                </div>
                                <div id="bookletEmbossingWarning" class="warning-text">Минимальное количество - 20 ударов</div>
                                <div id="bookletEmbossingError" class="error-message">Пожалуйста, введите корректное число</div>
                            </div>
                        </div>

                        <div class="checkbox-group">
                            <label class="checkbox-container lamination-tooltip-container">
                                Ламинация лифлетов
                                <span class="tooltip-icon">i</span>
                                <div class="tooltip-content lamination-tooltip">
                                    <div class="tooltip-text">Ламинация - покрытие защитной пленкой для увеличения срока службы и улучшения внешнего вида</div>
                                    <div class="lamination-animation">
                                        <div class="sheet-mockup-lamination">
                                            <div class="sheet-content">
                                                <div class="text-line"></div>
                                                <div class="text-line short"></div>
                                                <div class="text-line"></div>
                                                <div class="text-line short"></div>
                                                <div class="text-line"></div>
                                            </div>
                                            <div class="lamination-roller"></div>
                                            <div class="lamination-film"></div>
                                            <div class="lamination-shine"></div>
                                            <div class="lamination-shine-2"></div>
                                            <div class="lamination-effect"></div>
                                            <div class="lamination-text-container">
                                                <div class="lamination-text-before">До ламинации</div>
                                                <div class="lamination-text-after">После ламинации</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="checkbox" id="laminationRequired">
                                <span class="checkmark"></span>
                            </label>
                                                    </div>

                        <div id="bookletLaminationOptions" class="additional-options">
                            <div class="form-group">
                                <label for="bookletLaminationType"><i class="fas fa-film"></i> Тип ламинации:</label>
                                <select id="bookletLaminationType">
                                    <option value="1">Глянцевая</option>
                                    <option value="2">Матовая</option>
                                    <option value="3">Самоклеяющаяся</option>
                                    <option value="4">Софт тач</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group book-only">
                        <label for="bookQuantity"><i class="fas fa-copy"></i> Тираж (количество книг):</label>
                        <input type="number" id="bookQuantity" min="1" value="10" required placeholder="Минимум 10">
                        <div id="bookQuantityError" class="error-message">Минимальный тираж - 10 книг</div>
                    </div>

                    <div class="form-group book-only">
                        <h3 class="section-title"><i class="fas fa-book-open"></i> Блок книги</h3>
                        <label for="bookBodyColorType"><i class="fas fa-palette"></i> Цветность блока книги:</label>
                        <select id="bookBodyColorType" required>
                            <option value="4">1+1 (двусторонняя черно-белая)</option>
                            <option value="2">4+4 (двусторонняя цветная)</option>
                            <option value="8">4+1 (смешанная печать)</option>
                        </select>
                    </div>

                    <div class="form-group book-only">
                        <label for="bookBodyFormat"><i class="fas fa-expand-alt"></i> Формат блока книги:</label>
                        <select id="bookBodyFormat" required>
                            <option value="2">А4 (210х297 мм)</option>
                            <option value="3">А5 (148х210 мм)</option>
                            <option value="4">А6 (105х148 мм)</option> <!-- Добавлена опция А6 -->
                        </select>
                    </div>

                    <div class="form-group book-only">
                        <label for="bookBodySheets"><i class="fas fa-file-alt"></i> Количество листов в одной книге:</label>
                        <input type="number" id="bookBodySheets" min="5" value="5" required placeholder="Минимум 5 листов">
                        <div id="bookBodySheetsError" class="error-message">Минимальное количество - 5 листов</div>
                    </div>

                    <div class="form-group book-only">
                        <label for="bookBodyPaperType"><i class="fas fa-file-alt"></i> Тип бумаги для блока книги:</label>
                        <select id="bookBodyPaperType" required>
                            <optgroup label="Офисная">
                                <option value="1">ВХИ</option>
                            </optgroup>
                            <optgroup label="Мелованная">
                                <option value="2">90-115 г/м²</option>
                                <option value="3">130-170 г/м²</option>
                            </optgroup>
                        </select>
                    </div>

                    <div class="form-group book-only">
                        <h3 class="section-title"><i class="fas fa-book"></i> Обложка книги</h3>
                        <label class="checkbox-container">
                            Обложка не требуется
                            <input type="checkbox" id="bookCoverNotRequired">
                            <span class="checkmark"></span>
                        </label>
                    </div>

                    <div id="bookCoverOptions" class="book-only">
                        <div class="form-group">
                            <label for="bookCoverColorType"><i class="fas fa-palette"></i> Цветность обложки:</label>
                            <select id="bookCoverColorType">
                                <option value="4">1+1 (двусторонняя черно-белая)</option>
                                <option value="2">4+4 (двусторонняя цветная)</option>
                                <option value="6">4+0 (односторонняя цветная)</option>
                                <option value="8">4+1 (смешанная печать)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="bookCoverPaperType"><i class="fas fa-file-alt"></i> Тип бумаги для обложки:</label>
                            <select id="bookCoverPaperType">
                                <optgroup label="Для твердого переплета и скрепки">
                                    <option value="2">115 г/м²</option>
                                </optgroup>
                                <optgroup label="Для мягкого переплета и скрепки">
                                    <option value="4">250 г/м²</option>
                                    <option value="6">Картон</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-group">
                        <label for="bookCoverLaminationType"><i class="fas fa-film"></i> Ламинация обложки:</label>
                        <select id="bookCoverLaminationType">
                            <option value="0" selected>Нет</option>
                            <option value="1">Глянцевая</option>
                            <option value="2">Матовая</option>
                            <option value="3">Софт тач</option>
                        </select>
                    </div>
                    </div>

                    <!-- Постпечатная обработка для книг -->
                    <div class="postprint-section book-only">
                        <h3 class="section-title"><i class="fas fa-tools"></i> Переплет книги</h3>
                        
                        <div class="form-group">
                            <label for="bookBindingType"><i class="fas fa-book"></i> Тип переплета:</label>
                            <select id="bookBindingType">
                                <option value="hard">Твердый переплет</option>
                                <option value="soft">Мягкий переплет</option>
                                <option value="staple">Скрепка</option>
                            </select>
                        </div>
                    </div>

                    <div class="postprint-section visiting-card-only">
                        <h3 class="section-title"><i class="fas fa-tools"></i> Дополнительная обработка визиток</h3>

                        <div class="checkbox-group">
                            <label class="checkbox-container">
                                Скругление углов визиток
                                <input type="checkbox" id="visitingCornerRoundingRequired">
                                <span class="checkmark"></span>
                            </label>
                        </div>

                        <div id="visitingCornerRoundingOptions" class="additional-options">
                            <div class="form-group">
                            <label for="visitingCornerRoundingSheets"><i class="fas fa-circle"></i> Количество листов для округления:</label>
                            <div class="input-with-button">
                            <input type="number" id="visitingCornerRoundingSheets" min="1" value="1" placeholder="Введите количество листов">
                             <button type="button" class="all-button" id="visitingCornerRoundingAllButton">все</button>
                            </div>
                            <div id="visitingCornerRoundingError" class="error-message">Пожалуйста, введите корректное число</div>
                            </div>
                        </div>
                        <!-- Добавляем в секцию дополнительной обработки визиток после скругления углов -->
                        <div class="checkbox-group">
                           <label class="checkbox-container lamination-tooltip-container">
                                Ламинация визиток
                                <span class="tooltip-icon">i</span>
                                <div class="tooltip-content lamination-tooltip">
                                    <div class="tooltip-text">Ламинация - покрытие защитной пленкой для увеличения срока службы и улучшения внешнего вида</div>
                                    <div class="lamination-animation">
                                        <div class="sheet-mockup-lamination">
                                            <div class="sheet-content">
                                                <div class="text-line"></div>
                                                <div class="text-line short"></div>
                                                <div class="text-line"></div>
                                                <div class="text-line short"></div>
                                                <div class="text-line"></div>
                                            </div>
                                            <div class="lamination-roller"></div>
                                            <div class="lamination-film"></div>
                                            <div class="lamination-shine"></div>
                                            <div class="lamination-shine-2"></div>
                                            <div class="lamination-effect"></div>
                                            <div class="lamination-text-container">
                                                <div class="lamination-text-before">До ламинации</div>
                                                <div class="lamination-text-after">После ламинации</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="checkbox" id="laminationRequired">
                                <span class="checkmark"></span>
                            </label>
                        </div>

                        <div id="visitingLaminationOptions" class="additional-options">
                            <div class="form-group">
                                <label for="visitingLaminationType"><i class="fas fa-film"></i> Тип ламинации:</label>
                                <select id="visitingLaminationType">
                                    <option value="1">Матовая</option>
                                    <option value="2">Софт тач</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="postprint-section not-for-visiting">
                        <h3 class="section-title"><i class="fas fa-tools"></i> Постпечатная обработка</h3>

                        <div class="checkbox-group">
                            <label class="checkbox-container">
                                Требуется постпечатная обработка
                                <input type="checkbox" id="postprintRequired">
                                <span class="checkmark"></span>
                            </label>
                        </div>

                        <div id="postprintOptions" class="postprint-options">
                            <div class="checkbox-group">
                                <label class="checkbox-container embossing-tooltip-container">
                                    Тиснение
                                    <span class="tooltip-icon">i</span>
                                    <div class="tooltip-content embossing-tooltip">
                                        <div class="tooltip-text">Тиснение - процесс нанесения рельефного изображения с помощью пресса</div>
                                        <div class="embossing-animation">
                                            <div class="sheet-wrapper">
                                                <div class="sheet-embossing">
                                                    <div class="sheet-content">
                                                        <div class="text-line"></div>
                                                        <div class="text-line short"></div>
                                                        <div class="text-line"></div>
                                                        <div class="text-line short"></div>
                                                        <div class="text-line"></div>
                                                    </div>
                                                    <div class="harmony-text">Гармония</div>
                                                </div>
                                                <div class="press"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="checkbox" id="embossingRequired">
                                    <span class="checkmark"></span>
                                </label>
                            </div>

                            <div id="embossingOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="embossingHits"><i class="fas fa-hammer"></i> Количество ударов:</label>
                                    <div class="input-with-button">
                                        <input type="number" id="embossingHits" min="1" value="20" placeholder="Минимум 20 ударов">
                                        <button type="button" class="all-button" id="embossingAllButton">все</button>
                                    </div>
                                    <div id="embossingWarning" class="warning-text">Минимальное количество - 20 ударов</div>
                                    <div id="embossingError" class="error-message">Пожалуйста, введите корректное число</div>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <label class="checkbox-container">
                                    Вырубка
                                    <input type="checkbox" id="dieCuttingRequired">
                                    <span class="checkmark"></span>
                                </label>
                            </div>

                            <div id="dieCuttingOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="dieCuttingHits"><i class="fas fa-cut"></i> Количество ударов:</label>
                                    <div class="input-with-button">
                                        <input type="number" id="dieCuttingHits" min="1" value="20" placeholder="Минимум 20 ударов">
                                        <button type="button" class="all-button" id="dieCuttingAllButton">все</button>
                                    </div>
                                    <div id="dieCuttingWarning" class="warning-text">Минимальное количество - 20 ударов</div>
                                    <div id="dieCuttingError" class="error-message">Пожалуйста, введите корректное число</div>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <label class="checkbox-container lamination-tooltip-container">
                                    Ламинация
                                    <span class="tooltip-icon">i</span>
                                    <div class="tooltip-content lamination-tooltip">
                                        <div class="tooltip-text">Ламинация - покрытие защитной пленкой для увеличения срока службы и улучшения внешнего вида</div>
                                        <div class="lamination-animation">
                                            <div class="sheet-mockup-lamination">
                                                <div class="sheet-content">
                                                    <div class="text-line"></div>
                                                    <div class="text-line short"></div>
                                                    <div class="text-line"></div>
                                                    <div class="text-line short"></div>
                                                    <div class="text-line"></div>
                                                </div>
                                                <div class="lamination-roller"></div>
                                                <div class="lamination-film"></div>
                                                <div class="lamination-shine"></div>
                                                <div class="lamination-shine-2"></div>
                                                <div class="lamination-effect"></div>
                                                <div class="lamination-text-container">
                                                    <div class="lamination-text-before">До ламинации</div>
                                                    <div class="lamination-text-after">После ламинации</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="checkbox" id="laminationRequired">
                                    <span class="checkmark"></span>
                                </label>
                            </div>

                            <div id="laminationOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="laminationType"><i class="fas fa-film"></i> Тип ламинации:</label>
                                    <select id="laminationType">
                                        <option value="1">Глянцевая</option>
                                        <option value="2">Матовая</option>
                                        <option value="3">Самоклеяющаяся</option>
                                        <option value="4">Софт тач</option>
                                    </select>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <label class="checkbox-container">
                                    Биговка
                                    <input type="checkbox" id="scoringRequired">
                                    <span class="checkmark"></span>
                                </label>
                            </div>

                            <div id="scoringOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="scoringHits"><i class="fas fa-grip-lines"></i> Количество бигов в одном изделии:</label>
                                    <input type="number" id="scoringHits" min="1" value="1" placeholder="Введите количество бигов">
                                    <div id="scoringError" class="error-message">Пожалуйста, введите корректное число</div>
                                </div>
                            </div>

                            <label class="checkbox-container folding-tooltip-container">
                                Фальцовка
                                <span class="tooltip-icon">i</span>
                                <div class="tooltip-content folding-tooltip">
                                    <div class="tooltip-text">Фальцовка - сгибание листа в определенной последовательности для формирования тетрадей, брошюр и т.д.</div>
                                    <div class="folding-animation">
                                        <div class="sheet-mockup-folding">
                                            <div class="sheet-base"></div>
                                            <div class="folded-part"></div>
                                            <div class="fold-line"></div>
                                            <div class="highlight-area"></div>
                                        </div>
                                    </div>
                                </div>
                                <input type="checkbox" id="foldingRequired">
                                <span class="checkmark"></span>
                            </label>

                            <div id="foldingOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="foldingHits"><i class="fas fa-bars"></i> Количество ударов (фальцев) в одном изделии:</label>
                                    <input type="number" id="foldingHits" min="1" value="1" placeholder="Введите количество фальцев">
                                    <div id='foldingError' class="error-message">Пожалуйста, введите корректное число</div>
                                </div>
                            </div>

                            <label class="checkbox-container corner-rounding-tooltip-container">
                                Скругление углов
                                <span class="tooltip-icon">i</span>
                                <div class="tooltip-content corner-rounding-tooltip">
                                    <div class="tooltip-text">Скругление углов - сглаживание острых углов на изделии</div>
                                    <div class="corner-rounding-animation">
                                        <div class="sheet-mockup-corner">
                                            <div class="sheet-content">
                                                <div class="text-line"></div>
                                                <div class="text-line short"></div>
                                                <div class="text-line"></div>
                                                <div class="text-line short"></div>
                                                <div class="text-line"></div>
                                            </div>
                                            <div class="corner-animation">
                                                <div class="corner-sharp"></div>
                                                <div class="corner-round"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="checkbox" id="cornerRoundingRequired">
                                <span class="checkmark"></span>
                            </label>

                            <div id="cornerRoundingOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="cornerRoundingSheets"><i class="fas fa-circle"></i> Количество листов для скругления:</label>
                                    <div class="input-with-button">
                                        <input type="number" id="cornerRoundingSheets" min="1" value="1" placeholder="Введите количество листов">
                                        <button type="button" class="all-button" id="cornerRoundingAllButton">все</button>
                                    </div>
                                    <div id="cornerRoundingError" class="error-message">Пожалуйста, введите корректное число</div>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <label class="checkbox-container numbering-tooltip-container">
                                    Нумерация
                                    <span class="tooltip-icon">i</span>
                                    <div class="tooltip-content numbering-tooltip">
                                    <div class="tooltip-text">Нумерация - печать порядковых номеров на документах</div>
                                    <div class="numbering-animation">
                                        <div class="sheet-mockup">
                                            <div class="sheet-content">
                                                <div class="text-line"></div>
                                                <div class="text-line short"></div>
                                                <div class="text-line"></div>
                                                <div class="text-line short"></div>
                                                <div class="text-line"></div>
                                            </div>
                                            <div class="page-number-animated">
                                                <span class="number">1</span>
                                                <span class="number">2</span>
                                                <span class="number">3</span>
                                                <span class="number">4</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                    <input type="checkbox" id="numberingRequired">
                                    <span class="checkmark"></span>
                                </label>
                            </div>

                            <div id="numberingOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="numberingSheets"><i class="fas fa-sort-numeric-down"></i> Количество листов для нумерации:</label>
                                    <div class="input-with-button">
                                        <input type="number" id="numberingSheets" min="1" value="1" placeholder="Введите количество листов">
                                        <button type="button" class="all-button" id="numberingAllButton">все</button>
                                    </div>
                                    <div id="numberingError" class="error-message">Пожалуйста, введите корректное число</div>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <label class="checkbox-container">
                                    Перфорация
                                    <input type="checkbox" id="perforationRequired">
                                    <span class="checkmark"></span>
                                </label>
                            </div>

                            <div id="perforationOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="perforationSheets"><i class="fas fa-cut"></i> Количество листов для перфорации:</label>
                                    <div class="input-with-button">
                                        <input type="number" id="perforationSheets" min="1" value="1" placeholder="Введите количество листов">
                                        <button type="button" class="all-button" id="perforationAllButton">все</button>
                                    </div>
                                    <div id="perforationError" class="error-message">Пожалуйста, введите корректное число</div>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <label class="checkbox-container">
                                    Склейка
                                    <input type="checkbox" id="gluingRequired">
                                    <span class="checkmark"></span>
                                </label>
                            </div>

                            <div id="gluingOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="gluingSheets"><i class="fas fa-paste"></i> Количество листов для склейки:</label>
                                    <div class="input-with-button">
                                        <input type="number" id="gluingSheets" min="1" value="1" placeholder="Введите количество листов">
                                        <button type="button" class="all-button" id="gluingAllButton">все</button>
                                    </div>
                                    <div id="gluingError" class="error-message">Пожалуйста, введите корректное число</div>
                                </div>
                            </div>

                            <div class="checkbox-group">
                                <label class="checkbox-container">
                                    Переплет
                                    <input type="checkbox" id="bindingRequired">
                                    <span class="checkmark"></span>
                                </label>
                            </div>

                            <div id="bindingOptions" class="additional-options">
                                <div class="form-group">
                                    <label for="bindingType"><i class="fas fa-book"></i> Тип переплета:</label>
                                        <select id="bindingType">
                                            <option value="staple" selected>Скрепка</option>
                                            <option value="spiral">Пружина</option>
                                        </select>
                                </div>

                                <div id="spiralOptions">
                                    <div class="form-group">
                                        <label for="bindingSheets"><i class="fas fa-book"></i> Количество листов для переплета:</label>
                                            <div class="input-with-button">
                                                <input type="number" id="bindingSheets" min="1" value="20" placeholder="Минимум 20 листов">
                                            </div>
                                        <div id="bindingError" class="error-message">Пожалуйста, введите корректное число</div>
                                    </div>
                                    <div class="checkbox-group">
                                        <label class="checkbox-container">
                                            С обложкой
                                            <input type="checkbox" id="bindingWithCover">
                                            <span class="checkmark"></span>
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label for="bindingCount"><i class="fas fa-copy"></i> Количество переплетов:</label>
                                        <input type="number" id="bindingCount" min="1" value="1" placeholder="Введите количество переплетов">
                                        <div id="bindingCountError" class="error-message">Пожалуйста, введите корректное число</div>
                                    </div>
                                </div>

                                <div id="stapleOptions" style="display: none;">
                                    <div class="form-group">
                                        <label for="stapleBindingCount"><i class="fas fa-copy"></i> Количество переплетов (скрепок):</label>
                                        <input type="number" id="stapleBindingCount" min="1" value="1" placeholder="Введите количество переплетов">
                                        <div id="stapleBindingCountError" class="error-message">Пожалуйста, введите корректное число</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group save-button-container">
                        <button type="button" id="saveProductBtn" data-tooltip="Стоимость: 0 руб." class="button">
                            <div class="button-wrapper">
                                <div class="text">Сохранить</div>
                                <span class="icon">
                                    <svg viewBox="0 0 16 16" class="bi bi-cart2" fill="currentColor" height="16" width="16" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5zM3.14 5l1.25 5h8.22l1.25-5H3.14zM5 13a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0z"></path>
                                    </svg>
                                </span>
                            </div>
                        </button>
                    </div>
                </form>
            </div>

            <div class="right-column">
                <div class="result-container">
                    <h2 class="result-title"><i class="fas fa-receipt"></i> Стоимость текущего изделия</h2>
                    <div class="cost" id="currentCostValue">0 руб.</div>
                    <div id="minimalCostNote" class="minimal-cost">
                        <i class="fas fa-info-circle"></i> Минимальная сумму заказа составляет 200 рублей
                    </div>

                    <div class="details">
                        <div class="detail-item not-for-visiting">
                            <span class="detail-label"><i class="fas fa-palette"></i> Цена печати:</span>
                            <span class="detail-value" id="colorCost">0 руб.</span>
                        </div>
                        <div class="detail-item not-for-visiting">
                            <span class="detail-label"><i class="fas fa-file-alt"></i> Цена бумаги:</span>
                            <span class="detail-value" id="paperCost">0 руб.</span>
                        </div>
                        <div class="detail-item not-for-visiting">
                            <span class="detail-label"><i class="fas fa-cut"></i> Стоимость резки:</span>
                            <span class="detail-value" id="cuttingCost">0 руб.</span>
                        </div>
                        <div id="bookletScoringCostItem" class="detail-item booklet-only" style="display: none;">
                            <span class="detail-label"><i class="fas fa-grip-lines"></i> Биговка буклетов:</span>
                            <span class="detail-value" id="bookletScoringCost">0 руб.</span>
                        </div>
                        <div id="embossingCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-hammer"></i> Тиснение:</span>
                            <span class="detail-value" id="embossingCost">0 руб.</span>
                        </div>
                        <div id="dieCuttingCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-cut"></i> Вырубка:</span>
                            <span class="detail-value" id="dieCuttingCost">0 руб.</span>
                        </div>
                        <div id="laminationCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-film"></i> Ламинация:</span>
                            <span class="detail-value" id="laminationCost">0 руб.</span>
                        </div>
                        <div id="scoringCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-grip-lines"></i> Биговка:</span>
                            <span class="detail-value" id="scoringCost">0 руб.</span>
                        </div>
                        <div id="foldingCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-bars"></i> Фальцовка:</span>
                            <span class="detail-value" id="foldingCost">0 руб.</span>
                        </div>
                        <div id="cornerRoundingCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-circle"></i> Скругление углов:</span>
                            <span class="detail-value" id="cornerRoundingCost">0 руб.</span>
                        </div>
                        <div id="numberingCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-sort-numeric-down"></i> Нумерация:</span>
                            <span class="detail-value" id="numberingCost">0 руб.</span>
                        </div>
                        <div id="perforationCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-cut"></i> Перфорация:</span>
                            <span class="detail-value" id="perforationCost">0 руб.</span>
                        </div>
                        <div id="gluingCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-paste"></i> Склейка:</span>
                            <span class="detail-value" id="gluingCost">0 руб.</span>
                        </div>
                        <div id="bindingCostItem" class="detail-item not-for-visiting" style="display: none;">
                            <span class="detail-label"><i class="fas fa-book"></i> Переплет:</span>
                            <span class="detail-value" id="bindingCost">0 руб.</span>
                        </div>
                        <div id="bookBodyCostItem" class="detail-item book-only" style="display: none;">
                            <span class="detail-label"><i class="fas fa-book-open"></i> Блок книги:</span>
                            <span class="detail-value" id="bookBodyCost">0 руб.</span>
                        </div>
                        <div id="bookCoverCostItem" class="detail-item book-only" style="display: none;">
                            <span class="detail-label"><i class="fas fa-book"></i> Обложка:</span>
                            <span class="detail-value" id="bookCoverCost">0 руб.</span>
                        </div>
                        <div id="bookBindingCostItem" class="detail-item book-only" style="display: none;">
                            <span class="detail-label"><i class="fas fa-book"></i> Переплет книги:</span>
                            <span class="detail-value" id="bookBindingCost">0 руб.</span>
                        </div>
                        <div class="detail-item not-for-visiting">
                            <span class="detail-label"><i class="fas fa-sticky-note"></i> Количество на листе А3:</span>
                            <span class="detail-value" id="itemsPerSheet">0</span>
                        </div>
                        <div class="detail-item not-for-visiting">
                            <span class="detail-label"><i class="fas fa-layer-group"></i> Затрачено листов А3:</span>
                            <span class="detail-value" id="sheetsUsed">0</span>
                        </div>
                    </div>
                </div>

                <div class="mockup-container">
                    <h2 class="section-title"><i class="fas fa-th-large"></i> Макет листа</h2>
                    <div class="mockup-display">
                        <div class="a3-sheet" id="a3Sheet">
                            <!-- Здесь будет отображаться макет -->
                        </div>
                    </div>
                    <div class="mockup-info">
                        <p>На макете показано размещение изделий на листе формата А3</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Уведомление о стоимости -->
        <div id="notification" class="notification">
            <div class="notification-icon"> <i class="fas fa-check-circle"></i> </div>
            <div class="notification-content">
                <div class="notification-title">Стоимость пересчитана</div>
                <div> <span id="notificationCost">0 руб.</span></div>
            </div>
            <button class="notification-close"> <i class="fas fa-times"></i> </button>
        </div>

    <!-- Модальное окно подтверждения дубликата -->
        <div id="duplicateModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-title">Подтверждение добавления</div>
                <p>Изделие с такими параметрами уже есть в заказе. Вы уверены, что хотите добавить его снова?</p>
                <div class="modal-buttons">
                    <button class="modal-btn modal-cancel" id="modalCancel">Отмена</button>
                    <button class="modal-btn modal-confirm" id="modalConfirm">Добавить</button>
                </div>
            </div>
        </div>

    <!-- Добавьте этот код в секцию модальных окон после duplicateModal -->
        <div id="visitingCardSuggestionModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-title">Обнаружены размеры визиток</div>
                <p>Вы ввели размеры визиток (90×50 мм). Хотите перейти в раздел визиток?</p>
                <p>Текущее количество будет перенесено и округлено до ближайшего кратного 24.</p>
                <div class="modal-buttons">
                    <button class="modal-btn modal-cancel" id="visitingSuggestionCancel">Отмена</button>
                    <button class="modal-btn modal-confirm" id="visitingSuggestionConfirm">Перейти к визиткам</button>
                </div>
            </div>
        </div>

    <footer>
        <div class="footer-container">
            <p>© 2025 г. Типография "Гармония"</p>
            <p>Телефон: +7 (342) 232-00-33 | Email: harmony-prm@yandex.ru</p>
        </div>
    </footer>

    <script>
        // =============================================
        // КОНСТАНТЫ И ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // =============================================
        const DOLLARS = 83;
        const SHEET_WIDTH = 320;
        const SHEET_HEIGHT = 450;
        const CUT_MARGIN = 2;
        const KRAS1_PRICES = [0.578313253, 0.5301204819, 0.4096385542, 0.3614457831, 0.313253012, 0.2891566265];
        const KRAS2_PRICES = [1.13253012, 0.9638554217, 0.7228915663, 0.6987951807, 0.6265060241, 0.578313253];
        const KRAS3_PRICE = 0.1445783133;
        const KRAS4_PRICE = 0.2409638554;
        const PAPER_PRICES = [0.01927710843, 0.06024096385, 0.09638554216, 0.12155121951, 0.17073170731, 0.20731707317, 0.91463414634, 1.0844, 0.2892, 0.1807228916, 0.2409638554, 0.30120481];
        const EMBOSSING_SETUP = 8.4338;
        const DIE_CUTTING_SETUP = 8.4338;
        const MINIMAL_ORDER_COST = 200;
        const CUTTING_PRICE_PER_HIT = 7.7;
        const GLUING_PRICES = {2: 0.072289156, 3: 0.048192771};
        const SCORING_PRICE_PER_HIT = 0.02409638556;
        const FOLDING_PRICE_PER_HIT = 0.01204819278;
        const CORNER_ROUNDING_PRICE = 0.02409638556;
        const NUMBERING_PRICE = 0.01204819278;
        const PERFORATION_PRICE = 0.01204819278;
        const LAMINATION_PRICES = {1: 0.7229, 2: 1.2049, 3: 1.9278, 4: 1.8073};
        const BINDING_PRICES_A4 = {20: 0.6024096386, 40: 0.6626506034, 50: 0.9036144588, 60: 1.024096386, 70: 1.204819287, 85: 1.385542169, 105: 1.56626516};
        const BINDING_PRICES_A3 = {20: 1.265060241, 40: 1.325301205, 50: 1.445783133, 60: 1.56626516, 70: 1.686746988, 85: 1.807228916, 105: 2.048192781};
        const VISITING_CARD_PRICES = {
            '1_10': [4.00, 3.50, 3.30, 3.00], '5_10': [5.50, 5.00, 4.50, 3.50], '2_10': [6.00, 5.50, 5.00, 4.50],
            '1_13': [6.00, 5.50, 5.00, 5.00], '5_13': [7.00, 6.50, 6.00, 6.00], '2_13': [8.00, 7.50, 7.00, 7.00],
            '1_14': [6.00, 5.50, 5.00, 5.00], '5_14': [7.00, 6.50, 6.00, 6.00], '2_14': [8.00, 7.50, 7.00, 7.00],
            '1_15': [6.00, 5.50, 5.00, 5.00], '5_15': [7.00, 6.50, 6.00, 6.00], '2_15': [8.00, 7.50, 7.00, 7.00]
        };
        const VISITING_CARD_PRICES_MATTE_LAMINATION = {
            '1_10': [8.00, 7.50, 7.30, 7.10], 
            '5_10': [9.65, 9.15, 8.65, 7.65],
            '2_10': [10.15, 9.65, 9.15, 8.65]
        };
        const VISITING_CARD_PRICES_SOFT_TOUCH_LAMINATION = {
            '1_10': [9.40, 8.90, 8.70, 8.40],
            '5_10': [10.90, 10.40, 9.90, 8.90],
            '2_10': [11.40, 10.90, 10.40, 9.90]
        };
        const FORMAT_SIZES = {
            1: { width: 297, height: 420 }, 2: { width: 210, height: 297 }, 3: { width: 148, height: 210 },
            4: { width: 105, height: 148 }, 5: { width: 74, height: 105 }, 6: { width: 52, height: 74 }
        };
        const BOOK_PRICES = {
            '4': 12, '2': { '51-100': 50, '101-500': 45, '500+': 40 }
        };
        const BOOK_LAMINATION_PRICES = {
            1: 15, // Глянцевая
            2: 35, // Матовая
            3: 25  // Софт тач
        };
        const BOOK_BINDING_PRICES = {
            'hard': {
                'A4': { 'min': 300, 'mid': 280, 'max': 250 },
                'A5': { 'min': 280, 'mid': 260, 'max': 230 },
                'A6': { 'min': 260, 'mid': 240, 'max': 200 }
            },
            'soft': { 'setup': 1500, 'per_book': 20
            },
            'staple': 25
        };
        const STORAGE_KEYS = {
            PRODUCTS: 'harmony_products',
            FORM_STATE: 'harmony_form_state',
            PRODUCT_COUNTER: 'harmony_product_counter'
        };
        let products = [];
        let currentProductId = null;
        let productCounter = { sheet: 1, visiting: 1, booklet: 1, book: 1 };
        // =============================================
        // ФУНКЦИИ РАСЧЕТА СТОИМОСТИ ДЛЯ КНИГ
        // =============================================
        function calculateBookCost(product) {
            const quantity = product.bookQuantity || 10;
            const bodyColorType = product.bookBodyColorType || 4;
            const bodyFormat = product.bookBodyFormat || 2;
            const bodySheets = product.bookBodySheets || 1;
            const bodyPaperType = product.bookBodyPaperType || 1;
            const coverNotRequired = product.bookCoverNotRequired || false;
            const coverColorType = product.bookCoverColorType || 4;
            const coverPaperType = product.bookCoverPaperType || 1;
            const coverLaminationType = product.bookCoverLaminationType || 0; // 0 = нет ламинации
            const bindingType = product.bookBindingType || 'soft';
            // Расчет стоимости тела книги
            let bodyCost = 0;
            const totalBodySheets = quantity * bodySheets;
            if (bodyColorType == 4) { // 1+1 (черно-белая)
                let a3Sheets;
                if (bodyFormat == 2) a3Sheets = totalBodySheets / 2;
                else if (bodyFormat == 3) a3Sheets = totalBodySheets / 4;
                else if (bodyFormat == 4) a3Sheets = totalBodySheets / 8;
                else a3Sheets = totalBodySheets;
                bodyCost = BOOK_PRICES['4'] * a3Sheets;
                if (bodyPaperType != 1) bodyCost += (PAPER_PRICES[bodyPaperType-1] || 0) * a3Sheets * DOLLARS;
            } else if (bodyColorType == 2) { // 4+4 (цветная)
                let priceTier;
                if (totalBodySheets <= 50) priceTier = '51-100';
                else if (totalBodySheets <= 100) priceTier = '101-500';
                else priceTier = '500+';
                const pricePerA3Sheet = BOOK_PRICES['2'][priceTier];
                let a3Sheets;
                if (bodyFormat == 2) a3Sheets = totalBodySheets / 2;
                else if (bodyFormat == 3) a3Sheets = totalBodySheets / 4;
                else if (bodyFormat == 4) a3Sheets = totalBodySheets / 8;
                else { a3Sheets = totalBodySheets; }
                bodyCost = pricePerA3Sheet * a3Sheets;
                if (bodyPaperType != 1) bodyCost += (PAPER_PRICES[bodyPaperType-1] || 0) * a3Sheets * DOLLARS;
            } else if (bodyColorType == 8) { // 4+1 (смешанная печать) - как 4+0 + 1+0
                // Расчет для цветной стороны (4+0)
                let priceTier;
                if (totalBodySheets <= 50) priceTier = '51-100';
                else if (totalBodySheets <= 100) priceTier = '101-500';
                else priceTier = '500+';
                const colorPricePerA3Sheet = BOOK_PRICES['2'][priceTier] / 2;
                // Расчет для черно-белой стороны (1+0)
                const bwPricePerA3Sheet = BOOK_PRICES['4'] / 2;
                let a3Sheets;
                if (bodyFormat == 2) a3Sheets = totalBodySheets / 2;
                else if (bodyFormat == 3) a3Sheets = totalBodySheets / 4;
                else if (bodyFormat == 4) a3Sheets = totalBodySheets / 8;
                else { a3Sheets = totalBodySheets; }
                bodyCost = (colorPricePerA3Sheet + bwPricePerA3Sheet) * a3Sheets;
                if (bodyPaperType != 1) bodyCost += (PAPER_PRICES[bodyPaperType-1] || 0) * a3Sheets * DOLLARS;
            }
            // Расчет стоимости обложки - ТОЛЬКО ЕСЛИ ОБЛОЖКА ТРЕБУЕТСЯ
            let coverCost = 0;
            if (!coverNotRequired) {
                // Расчет печати обложки с учетом формата
                let a3SheetsForCover = quantity;
                if (coverColorType == 4) coverCost = BOOK_PRICES['4'] * a3SheetsForCover;
                else if (coverColorType == 2) { // 4+4
                    let priceTier;
                    if (quantity <= 50) priceTier = '51-100';
                    else if (quantity <= 100) priceTier = '101-500';
                    else priceTier = '500+';
                    const pricePerA3Sheet = BOOK_PRICES['2'][priceTier];
                    coverCost = pricePerA3Sheet * a3SheetsForCover;
                } else if (coverColorType == 6) { // 4+0
                    let priceTier;
                    if (quantity <= 50) priceTier = '51-100';
                    else if (quantity <= 100) priceTier = '101-500';
                    else priceTier = '500+';
                    const pricePerA3Sheet = BOOK_PRICES['2'][priceTier] / 2;
                    coverCost = pricePerA3Sheet * a3SheetsForCover;
                } else if (coverColorType == 8) { // 4+1
                    let priceTier;
                    if (quantity <= 50) priceTier = '51-100';
                    else if (quantity <= 100) priceTier = '101-500';
                    else priceTier = '500+';
                    const colorPricePerA3Sheet = BOOK_PRICES['2'][priceTier] / 2;
                    const bwPricePerA3Sheet = BOOK_PRICES['4'] / 2;
                    coverCost = (colorPricePerA3Sheet + bwPricePerA3Sheet) * a3SheetsForCover;
                }
                // Бумага для обложки
                if (coverPaperType != 1) coverCost += (PAPER_PRICES[coverPaperType-1] || 0) * a3SheetsForCover * DOLLARS;
                if (coverLaminationType != 0) coverCost += BOOK_LAMINATION_PRICES[coverLaminationType] * quantity;
            }
            // Расчет стоимости переплета - ВСЕГДА, даже если обложка не требуется
            let bindingCost = 0;
            if (bindingType === 'hard') {
                const formatKey = bodyFormat == 2 ? 'A4' : (bodyFormat == 3 ? 'A5' : 'A6');
                const priceInfo = BOOK_BINDING_PRICES.hard[formatKey];
                if (quantity <= 30) { bindingCost = priceInfo.min * quantity; }
                else if (quantity <= 99) { bindingCost = priceInfo.mid * quantity; }
                else { bindingCost = priceInfo.max * quantity; }
            }
            else if (bindingType === 'soft') bindingCost = BOOK_BINDING_PRICES.soft.setup + (BOOK_BINDING_PRICES.soft.per_book * quantity);
            else if (bindingType === 'staple') bindingCost = BOOK_BINDING_PRICES.staple * quantity;
            const totalCost = bodyCost + coverCost + bindingCost;
            return {
                totalCost: roundUpTo10(totalCost),
                bodyCost: bodyCost,
                coverCost: coverCost,
                bindingCost: bindingCost,
                itemsPerSheet: 1,
                sheetsUsed: quantity
            };
        }
        // =============================================
        // ФУНКЦИИ ОТОБРАЖЕНИЯ РЕЗУЛЬТАТОВ ДЛЯ КНИГ
        // =============================================
        function displayBookResults(costResult, product) {
            if (!costResult) return;
            // Сбрасываем все элементы стоимости
            resetCostDisplay();
            // Отображаем стоимость тела книги
            if (costResult.bodyCost > 0) {
                document.getElementById('bookBodyCost').textContent = `${costResult.bodyCost.toFixed(2)} руб.`;
                document.getElementById('bookBodyCostItem').style.display = 'flex';
            }
            // Отображаем информацию об обложке - либо стоимость, либо "нет"
            const coverNotRequired = document.getElementById('bookCoverNotRequired').checked;
            if (!coverNotRequired && costResult.coverCost > 0) {
                document.getElementById('bookCoverCost').textContent = `${costResult.coverCost.toFixed(2)} руб.`;
                document.getElementById('bookCoverCostItem').style.display = 'flex';
            } else if (coverNotRequired) {
                // Создаем элемент для отображения "Обложка: нет"
                document.getElementById('bookCoverCost').textContent = 'нет';
                document.getElementById('bookCoverCostItem').style.display = 'flex';
            }
            // ВСЕГДА отображаем стоимость переплета
            document.getElementById('bookBindingCost').textContent = `${costResult.bindingCost.toFixed(2)} руб.`;
            document.getElementById('bookBindingCostItem').style.display = 'flex';
            document.getElementById('itemsPerSheet').textContent = '1';
            document.getElementById('sheetsUsed').textContent = costResult.sheetsUsed;
        }
        // =============================================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        // =============================================
        function roundUpTo10(num) { return Math.ceil(num); }
        function generateId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }
        function getProductTypeName(type) { 
            const typeNames = { sheet: "Листовая печать", visiting: "Визитки", booklet: "Лифлеты", book: "Книги" };
            return typeNames[type] || "Изделие";
        }
        function getColorTypeName(colorTypeId) {
            const colorTypeNames = { 
                1: '4+0 (односторонняя цветная)', 2: '4+4 (двусторонняя цветная)', 
                3: '1+0 (односторонняя черно-белая)', 4: '1+1 (двусторонняя черно-белая)', 
                5: '4+1 (смешанная печать)', 6: '4+0 (односторонняя цветная)',
                7: '1+0 (односторонняя черно-белая)', 8: '4+1 (смешанная печать)'
            };
            return colorTypeNames[colorTypeId] || 'Неизвестный тип';
        }
        function getFormatName(formatId) {
            const formatNames = { 1: 'А3', 2: 'А4', 3: 'А5', 4: 'А6', 5: 'А7', 6: 'А8' };
            return formatNames[formatId] || 'Неизвестный формат';
        }
        function getPaperName(paperId) {
            const paperNames = { 
                1: 'ВХИ', 2: 'Мелованная 90-115 г/м²', 3: 'Мелованная 130-170 г/м²', 
                4: 'Мелованная 200-250 г/м²', 5: 'Мелованная 300 г/м²', 6: 'Картон 250-270 г/м²', 
                7: 'Лён', 8: 'Жемчуг', 9: 'Самоклейка', 10: '300 г/м²', 13: 'Дизайнерская', 
                14: 'Лён', 15: 'Жемчуг' 
            };
            return paperNames[paperId] || 'Неизвестная бумага';
        }
        function getLaminationTypeName(laminationTypeId) {
            const laminationTypeNames = { 1: 'Глянцевая', 2: 'Матовая', 3: 'Самоклеяющаяся', 4: 'Софт тач' };
            return laminationTypeNames[laminationTypeId] || 'Неизвестный тип';
        }
        function getPricePerHit(hits) {
            if (hits >= 200) return 0.0844;
            if (hits >= 100) return 0.1085;
            if (hits >= 50) return 0.1446;
            return 0.1808;
        }
        function getBindingPrice(sheets, format, withCover) {
            if (format !== 1 && format !== 2) return 0;
            let priceTable = format === 1 ? BINDING_PRICES_A3 : BINDING_PRICES_A4;
            let price = 0;
            
            if (sheets >= 105) price = priceTable[105];
            else if (sheets >= 85) price = priceTable[85];
            else if (sheets >= 70) price = priceTable[70];
            else if (sheets >= 60) price = priceTable[60];
            else if (sheets >= 50) price = priceTable[50];
            else if (sheets >= 40) price = priceTable[40];
            else if (sheets >= 20) price = priceTable[20];
            
            if (withCover) price += (format === 1 ? 0.3614457831 : 0.2409638554);
            return price;
        }
        function detectFormatBySize(width, height) {
            if (!width || !height) return null;
            const tolerance = 2;
            const orientations = [{width: width, height: height}, {width: height, height: width}];

            for (const orientation of orientations) {
                for (const [formatId, size] of Object.entries(FORMAT_SIZES)) {
                    if (Math.abs(orientation.width - size.width) <= tolerance && 
                        Math.abs(orientation.height - size.height) <= tolerance) {
                        return parseInt(formatId);
                    }
                }
            }
            return null;
        }
        // =============================================
        // ФУНКЦИИ РАБОТЫ С LOCALSTORAGE
        // =============================================
        function saveProductsToStorage() {
            try { localStorage.setItem(STORAGE_KEYS.PRODUCTS, JSON.stringify(products)); } 
            catch (error) { console.error('Ошибка сохранения продуктов:', error); }
        }
        function loadProductsFromStorage() {
            try {
                const savedProducts = localStorage.getItem(STORAGE_KEYS.PRODUCTS);
                if (savedProducts) { products = JSON.parse(savedProducts); return true; }
            } catch (error) { console.error('Ошибка загрузки продуктов:', error); }
            return false;
        }
        function saveProductCounterToStorage() {
            try { localStorage.setItem(STORAGE_KEYS.PRODUCT_COUNTER, JSON.stringify(productCounter)); } 
            catch (error) { console.error('Ошибка сохранения счетчика:', error); }
        }
        function loadProductCounterFromStorage() {
            try {
                const savedCounter = localStorage.getItem(STORAGE_KEYS.PRODUCT_COUNTER);
                if (savedCounter) { productCounter = JSON.parse(savedCounter); return true; }
            } catch (error) { console.error('Ошибка загрузки счетчика:', error); }
            return false;
        }
        function saveFormStateToStorage() {
            try {
                const formState = getFormData();
                delete formState.id;
                localStorage.setItem(STORAGE_KEYS.FORM_STATE, JSON.stringify(formState));
            } catch (error) { console.error('Ошибка сохранения состояния формы:', error); }
        }
        function loadFormStateFromStorage() {
            try {
                const savedFormState = localStorage.getItem(STORAGE_KEYS.FORM_STATE);
                if (savedFormState) {
                    const formState = JSON.parse(savedFormState);
                    fillFormFromState(formState);
                    return true;
                }
            } catch (error) { console.error('Ошибка загрузки состояния формы:', error); }
            return false;
        }
        function fillFormFromState(formState) {
            if (!formState) return;
            if (formState.type) {
                document.getElementById('productType').value = formState.type;
                toggleFieldsVisibility(formState.type);
            }
            if (formState.name) document.getElementById('productName').value = formState.name;
            if (formState.type === 'visiting') {
                if (formState.kras) document.getElementById('visitingColorType').value = formState.kras;
                if (formState.item) document.getElementById('visitingQuantity').value = formState.item;
                if (formState.pap) document.getElementById('visitingPaperType').value = formState.pap;
                if (formState.visitingCornerRoundingRequired !== undefined) document.getElementById('visitingCornerRoundingRequired').checked = formState.visitingCornerRoundingRequired;
                if (formState.visitingCornerRoundingSheets) document.getElementById('visitingCornerRoundingSheets').value = formState.visitingCornerRoundingSheets;
            } else if (formState.type === 'booklet') {
                if (formState.kras) document.getElementById('bookletColorType').value = formState.kras;
                if (formState.item) document.getElementById('bookletQuantity').value = formState.item;
                if (formState.pap) document.getElementById('bookletPaperType').value = formState.pap;
                if (formState.bookletSize) {
                    const sizeRadios = document.querySelectorAll('input[name="bookletSize"]');
                    sizeRadios.forEach(radio => { if (radio.value === formState.bookletSize) radio.checked = true; });
                }
                if (formState.bookletEmbossingRequired !== undefined) document.getElementById('bookletEmbossingRequired').checked = formState.bookletEmbossingRequired;
                if (formState.bookletEmbossingHits) document.getElementById('bookletEmbossingHits').value = formState.bookletEmbossingHits;
                if (formState.bookletLaminationRequired !== undefined) document.getElementById('bookletLaminationRequired').checked = formState.bookletLaminationRequired;
                if (formState.bookletLaminationType) document.getElementById('bookletLaminationType').value = formState.bookletLaminationType;
            } else if (formState.type === 'book') {
                if (formState.bookQuantity) document.getElementById('bookQuantity').value = formState.bookQuantity;
                if (formState.bookBodyColorType) document.getElementById('bookBodyColorType').value = formState.bookBodyColorType;
                if (formState.bookBodyFormat) document.getElementById('bookBodyFormat').value = formState.bookBodyFormat;
                if (formState.bookBodySheets) document.getElementById('bookBodySheets').value = formState.bookBodySheets;
                if (formState.bookBodyPaperType) document.getElementById('bookBodyPaperType').value = formState.bookBodyPaperType;
                if (formState.bookCoverNotRequired !== undefined) document.getElementById('bookCoverNotRequired').checked = formState.bookCoverNotRequired;
                if (formState.bookCoverColorType) document.getElementById('bookCoverColorType').value = formState.bookCoverColorType;
                if (formState.bookCoverPaperType) document.getElementById('bookCoverPaperType').value = formState.bookCoverPaperType;
                if (formState.bookCoverLaminationType) document.getElementById('bookCoverLaminationType').value = formState.bookCoverLaminationType;
                if (formState.bookBindingType) document.getElementById('bookBindingType').value = formState.bookBindingType;
            } else {
                if (formState.kras) document.getElementById('colorType').value = formState.kras;
                if (formState.item) document.getElementById('quantity').value = formState.item;
                if (formState.razmer) document.getElementById('formatType').value = formState.razmer;
                if (formState.pap) document.getElementById('paperType').value = formState.pap;
                if (formState.width) document.getElementById('width').value = formState.width;
                if (formState.height) document.getElementById('height').value = formState.height;
                if (formState.postprintRequired !== undefined) document.getElementById('postprintRequired').checked = formState.postprintRequired;
                const postprintOptions = ['embossing', 'dieCutting', 'lamination', 'scoring', 'folding', 'cornerRounding', 'numbering', 'perforation', 'gluing', 'binding'];
                postprintOptions.forEach(option => {
                    if (formState[option + 'Required'] !== undefined) document.getElementById(option + 'Required').checked = formState[option + 'Required'];
                    if (formState[option + (option === 'lamination' ? 'Type' : option === 'binding' ? 'Type' : 'Hits')]) {
                        const fieldName = option + (option === 'lamination' ? 'Type' : option === 'binding' ? 'Type' : 'Hits');
                        document.getElementById(fieldName).value = formState[fieldName];
                    }
                });
                if (formState.bindingCount) document.getElementById('bindingCount').value = formState.bindingCount;
                if (formState.bindingWithCover !== undefined) document.getElementById('bindingWithCover').checked = formState.bindingWithCover;
                if (formState.stapleBindingCount) document.getElementById('stapleBindingCount').value = formState.stapleBindingCount;
            }
            setTimeout(() => { updateVisibility(); calculateCost(); }, 100);
        }
        function handleFormChange() { saveFormStateToStorage(); }
        // =============================================
        // ФУНКЦИИ РАБОТЫ С ФОРМОЙ И ДАННЫМИ
        // =============================================
        function handleSizeChange() {
            const width = parseInt(document.getElementById('width').value) || 0;
            const height = parseInt(document.getElementById('height').value) || 0;
            const detectedFormat = detectFormatBySize(width, height);
            const formatSelect = document.getElementById('formatType');
            if (detectedFormat && formatSelect) {
                formatSelect.value = detectedFormat;
                document.getElementById('width').value = FORMAT_SIZES[detectedFormat].width;
                document.getElementById('height').value = FORMAT_SIZES[detectedFormat].height;
            } else if (width > 0 && height > 0) formatSelect.value = "";
            calculateCost();
        }
        function handleFormatChange() {
            const formatSelect = document.getElementById('formatType');
            const formatValue = formatSelect.value;
            if (formatValue && FORMAT_SIZES[formatValue]) {
                document.getElementById('width').value = FORMAT_SIZES[formatValue].width;
                document.getElementById('height').value = FORMAT_SIZES[formatValue].height;
            } else if (!formatValue) {
                const width = document.getElementById('width').value || 0;
                const height = document.getElementById('height').value || 0;
                if (!width || !height) {
                    document.getElementById('width').value = 297;
                    document.getElementById('height').value = 210;
                }
            }
            checkBindingAvailability();
            checkGluingAvailability();
            calculateCost();
        }
        function getFormData() {
            const productType = document.getElementById('productType').value;
            const isVisiting = productType === 'visiting';
            const isBooklet = productType === 'booklet';
            const isBook = productType === 'book';
            let data = {
                id: document.getElementById('productId').value || generateId(),
                type: productType,
                name: document.getElementById('productName').value || `${getProductTypeName(productType)} ${productCounter[productType] || 1}`,
                kras: isVisiting ? parseInt(document.getElementById('visitingColorType').value) : 
                      isBooklet ? parseInt(document.getElementById('bookletColorType').value) :
                      isBook ? 0 : // Для книг kras не используется
                      parseInt(document.getElementById('colorType').value) || 1,
                item: isVisiting ? (function() {
                    let visitingQuantity = parseInt(document.getElementById('visitingQuantity').value) || 96;
                    if (visitingQuantity % 24 !== 0) visitingQuantity = Math.ceil(visitingQuantity / 24) * 24;
                    if (visitingQuantity < 96) visitingQuantity = 96;
                    return visitingQuantity;
                })() : isBooklet ? parseInt(document.getElementById('bookletQuantity').value) || 100 :
                      isBook ? 0 : // Для книг item не используется
                      parseInt(document.getElementById('quantity').value) || 100,
                razmer: isVisiting ? 0 : isBooklet ? 2 : isBook ? 0 : parseInt(document.getElementById('formatType').value) || 3,
                pap: isVisiting ? parseInt(document.getElementById('visitingPaperType').value) : 
                     isBooklet ? parseInt(document.getElementById('bookletPaperType').value) :
                     isBook ? 0 : // Для книг pap не используется
                     parseInt(document.getElementById('paperType').value) || 2,
                width: isVisiting ? 50 : isBooklet ? 210 : isBook ? 0 : parseInt(document.getElementById('width').value) || 0,
                height: isVisiting ? 90 : isBooklet ? 297 : isBook ? 0 : parseInt(document.getElementById('height').value) || 0,
                postprintRequired: document.getElementById('postprintRequired') ? document.getElementById('postprintRequired').checked : false
            };
            if (productType === 'book') {
                data.bookQuantity = parseInt(document.getElementById('bookQuantity').value) || 10;
                data.bookBodyColorType = parseInt(document.getElementById('bookBodyColorType').value) || 4;
                data.bookBodyFormat = parseInt(document.getElementById('bookBodyFormat').value) || 2;
                data.bookBodySheets = parseInt(document.getElementById('bookBodySheets').value) || 1;
                data.bookBodyPaperType = parseInt(document.getElementById('bookBodyPaperType').value) || 1;
                data.bookCoverNotRequired = document.getElementById('bookCoverNotRequired').checked;
                data.bookCoverColorType = parseInt(document.getElementById('bookCoverColorType').value) || 4;
                data.bookCoverPaperType = parseInt(document.getElementById('bookCoverPaperType').value) || 1;
                data.bookCoverLaminationType = parseInt(document.getElementById('bookCoverLaminationType').value) || 0;
                data.bookBindingType = document.getElementById('bookBindingType').value;
            }
            if (isBooklet) {
                const bookletSize = document.querySelector('input[name="bookletSize"]:checked');
                data.bookletSize = bookletSize ? bookletSize.value : 'A4';
                if (data.bookletSize === 'A3') { data.width = 297; data.height = 420; data.razmer = 1; } 
                else { data.width = 210; data.height = 297; data.razmer = 2; }
                data.bookletEmbossingRequired = document.getElementById('bookletEmbossingRequired').checked;
                data.bookletEmbossingHits = parseInt(document.getElementById('bookletEmbossingHits').value) || 0;
                data.bookletLaminationRequired = document.getElementById('bookletLaminationRequired').checked;
                data.bookletLaminationType = parseInt(document.getElementById('bookletLaminationType').value) || 1;
            }
            if (!data.postprintRequired && productType !== 'booklet' && productType !== 'book') {
                const postprintOptions = ['embossing', 'dieCutting', 'lamination', 'scoring', 'folding', 'cornerRounding', 'numbering', 'perforation', 'gluing', 'binding'];
                postprintOptions.forEach(option => { data[option + 'Required'] = false; });
            } else if (data.postprintRequired && productType !== 'book') {
                data.embossingRequired = document.getElementById('embossingRequired').checked;
                data.embossingHits = parseInt(document.getElementById('embossingHits').value) || 0;
                data.dieCuttingRequired = document.getElementById('dieCuttingRequired').checked;
                data.dieCuttingHits = parseInt(document.getElementById('dieCuttingHits').value) || 0;
                data.laminationRequired = document.getElementById('laminationRequired').checked;
                data.laminationType = parseInt(document.getElementById('laminationType').value) || 1;
                data.scoringRequired = document.getElementById('scoringRequired').checked;
                data.scoringHits = parseInt(document.getElementById('scoringHits').value) || 0;
                data.foldingRequired = document.getElementById('foldingRequired').checked;
                data.foldingHits = parseInt(document.getElementById('foldingHits').value) || 0;
                data.cornerRoundingRequired = document.getElementById('cornerRoundingRequired').checked;
                data.cornerRoundingSheets = parseInt(document.getElementById('cornerRoundingSheets').value) || 0;
                data.numberingRequired = document.getElementById('numberingRequired').checked;
                data.numberingSheets = parseInt(document.getElementById('numberingSheets').value) || 0;
                data.perforationRequired = document.getElementById('perforationRequired').checked;
                data.perforationSheets = parseInt(document.getElementById('perforationSheets').value) || 0;
                data.gluingRequired = document.getElementById('gluingRequired').checked;
                data.gluingSheets = parseInt(document.getElementById('gluingSheets').value) || 0;
                data.bindingRequired = document.getElementById('bindingRequired').checked;
                data.bindingType = document.getElementById('bindingType') ? document.getElementById('bindingType').value : 'staple';
                data.bindingSheets = parseInt(document.getElementById('bindingSheets').value) || 0;
                data.bindingCount = parseInt(document.getElementById('bindingCount').value) || 1;
                data.bindingWithCover = document.getElementById('bindingWithCover') ? document.getElementById('bindingWithCover').checked : false;
                data.stapleBindingCount = parseInt(document.getElementById('stapleBindingCount').value) || 1;
            }
            if (isVisiting) {
                data.visitingCornerRoundingRequired = document.getElementById('visitingCornerRoundingRequired').checked;
                data.visitingCornerRoundingSheets = parseInt(document.getElementById('visitingCornerRoundingSheets').value) || 0;
                data.visitingLaminationRequired = document.getElementById('visitingLaminationRequired').checked;
                data.visitingLaminationType = parseInt(document.getElementById('visitingLaminationType').value) || 1;
            }
            return data;
        }
        function fillForm(product) {
            if (!product) return;
            document.getElementById('productId').value = product.id;
            document.getElementById('productType').value = product.type;
            document.getElementById('productName').value = product.name;
            if (product.type === 'visiting') {
                document.getElementById('visitingColorType').value = product.kras;
                document.getElementById('visitingQuantity').value = product.item;
                document.getElementById('visitingPaperType').value = product.pap;
                document.getElementById('visitingCornerRoundingRequired').checked = product.visitingCornerRoundingRequired || false;
                document.getElementById('visitingCornerRoundingSheets').value = product.visitingCornerRoundingSheets || 0;
                document.getElementById('visitingLaminationRequired').checked = product.visitingLaminationRequired || false;
                document.getElementById('visitingLaminationType').value = product.visitingLaminationType || 1;
            } else if (product.type === 'booklet') {
                document.getElementById('bookletColorType').value = product.kras;
                document.getElementById('bookletQuantity').value = product.item;
                document.getElementById('bookletPaperType').value = product.pap;
                const sizeRadios = document.querySelectorAll('input[name="bookletSize"]');
                sizeRadios.forEach(radio => { if (radio.value === product.bookletSize) radio.checked = true; });
                document.getElementById('bookletEmbossingRequired').checked = product.bookletEmbossingRequired || false;
                document.getElementById('bookletEmbossingHits').value = product.bookletEmbossingHits || 0;
                document.getElementById('bookletLaminationRequired').checked = product.bookletLaminationRequired || false;
                document.getElementById('bookletLaminationType').value = product.bookletLaminationType || 1;
            } else if (product.type === 'book') {
                document.getElementById('bookQuantity').value = product.bookQuantity || 10;
                document.getElementById('bookBodyColorType').value = product.bookBodyColorType || 4;
                document.getElementById('bookBodyFormat').value = product.bookBodyFormat || 2;
                document.getElementById('bookBodySheets').value = product.bookBodySheets || 1;
                document.getElementById('bookBodyPaperType').value = product.bookBodyPaperType || 1;
                document.getElementById('bookCoverNotRequired').checked = product.bookCoverNotRequired || false;
                document.getElementById('bookCoverColorType').value = product.bookCoverColorType || 4;
                document.getElementById('bookCoverPaperType').value = product.bookCoverPaperType || 2; // 115 по умолчанию
                document.getElementById('bookCoverLaminationType').value = product.bookCoverLaminationType || 0; // Нет по умолчанию
                document.getElementById('bookBindingType').value = product.bookBindingType || 'staple';
            } else {
                document.getElementById('colorType').value = product.kras;
                document.getElementById('quantity').value = product.item;
                document.getElementById('formatType').value = product.razmer;
                document.getElementById('paperType').value = product.pap;
                document.getElementById('width').value = product.width;
                document.getElementById('height').value = product.height;
            }
            document.getElementById('postprintRequired').checked = product.postprintRequired || false;
            if (product.postprintRequired && product.type !== 'book') {
                document.getElementById('embossingRequired').checked = product.embossingRequired || false;
                document.getElementById('embossingHits').value = product.embossingHits || 0;
                document.getElementById('dieCuttingRequired').checked = product.dieCuttingRequired || false;
                document.getElementById('dieCuttingHits').value = product.dieCuttingHits || 0;
                document.getElementById('laminationRequired').checked = product.laminationRequired || false;
                document.getElementById('laminationType').value = product.laminationType || 1;
                document.getElementById('scoringRequired').checked = product.scoringRequired || false;
                document.getElementById('scoringHits').value = product.scoringHits || 0;
                document.getElementById('foldingRequired').checked = product.foldingRequired || false;
                document.getElementById('foldingHits').value = product.foldingHits || 0;
                document.getElementById('cornerRoundingRequired').checked = product.cornerRoundingRequired || false;
                document.getElementById('cornerRoundingSheets').value = product.cornerRoundingSheets || 0;
                document.getElementById('numberingRequired').checked = product.numberingRequired || false;
                document.getElementById('numberingSheets').value = product.numberingSheets || 0;
                document.getElementById('perforationRequired').checked = product.perforationRequired || false;
                document.getElementById('perforationSheets').value = product.perforationSheets || 0;
                document.getElementById('gluingRequired').checked = product.gluingRequired || false;
                document.getElementById('gluingSheets').value = product.gluingSheets || 0;
                document.getElementById('bindingRequired').checked = product.bindingRequired || false;
                document.getElementById('bindingSheets').value = product.bindingSheets || 0;
                document.getElementById('bindingCount').value = product.bindingCount || 1;
                document.getElementById('bindingWithCover').checked = product.bindingWithCover || false;
                if (document.getElementById('bindingType')) document.getElementById('bindingType').value = product.bindingType || 'staple';
                document.getElementById('stapleBindingCount').value = product.stapleBindingCount || 1;
            }
            currentProductId = product.id;
            updateVisibility();
        }
        function updateVisibility() {
            const productType = document.getElementById('productType').value;
            const postprintRequired = document.getElementById('postprintRequired').checked;
            const postprintOptions = document.getElementById('postprintOptions');
            if (postprintOptions) postprintOptions.style.display = (postprintRequired && productType !== 'book') ? 'block' : 'none';
            const options = ['embossing', 'dieCutting', 'lamination', 'scoring', 'folding', 'cornerRounding', 'numbering', 'perforation', 'gluing', 'binding', 'visitingCornerRounding', 'bookletEmbossing', 'bookletLamination', 'visitingLamination'];
            options.forEach(option => {
                const checkbox = document.getElementById(option + 'Required');
                const optionsDiv = document.getElementById(option + 'Options');
                if (checkbox && optionsDiv) optionsDiv.style.display = checkbox.checked ? 'block' : 'none';
            });
            if (productType === 'book') updateBookBindingOptions();
            const visitingPaperType = document.getElementById('visitingPaperType');
            const visitingLaminationRequired = document.getElementById('visitingLaminationRequired');
            const visitingLaminationOptions = document.getElementById('visitingLaminationOptions');
            if (visitingPaperType && visitingLaminationRequired && visitingLaminationOptions) {
                const isLaminationAvailable = visitingPaperType.value === '10'; // 300 г/м²
                if (!isLaminationAvailable) {
                    visitingLaminationRequired.checked = false;
                    visitingLaminationOptions.style.display = 'none';
                }
                visitingLaminationRequired.disabled = !isLaminationAvailable;
                visitingLaminationRequired.parentElement.style.opacity = isLaminationAvailable ? '1' : '0.5';
                if (isLaminationAvailable && visitingLaminationRequired.checked) visitingLaminationOptions.style.display = 'block';
            }
            const bindingType = document.getElementById('bindingType') ? document.getElementById('bindingType').value : 'staple';
            const spiralOptions = document.getElementById('spiralOptions');
            const stapleOptions = document.getElementById('stapleOptions');
            if (spiralOptions) spiralOptions.style.display = bindingType === 'spiral' ? 'block' : 'none';
            if (stapleOptions) stapleOptions.style.display = bindingType === 'staple' ? 'block' : 'none';
            checkBindingAvailability();
            checkGluingAvailability();
            setTimeout(calculateCost, 10);
        }
        function updateProductName(productType) {
            const nameField = document.getElementById('productName');
            if (nameField && (!nameField.value || nameField.value.includes('Листовая печать') || 
                nameField.value.includes('Визитки') || nameField.value.includes('Лифлеты') || nameField.value.includes('Книги'))) {
                nameField.value = `${getProductTypeName(productType)} ${productCounter[productType] || 1}`;
            }
        }
        function toggleFieldsVisibility(productType) {
            document.body.classList.remove('visiting-card-selected', 'booklet-selected', 'book-selected');
            resetCostDisplay();
            if (productType === 'visiting') {
                document.body.classList.add('visiting-card-selected');
                const quantityGroup = document.querySelector('.form-group:has(#quantity)');
                if (quantityGroup) quantityGroup.style.display = 'none';
                const bookletQuantityGroup = document.querySelector('.form-group:has(#bookletQuantity)');
                if (bookletQuantityGroup) bookletQuantityGroup.style.display = 'none';
                const visitingQuantityGroup = document.querySelector('.form-group:has(#visitingQuantity)');
                if (visitingQuantityGroup) visitingQuantityGroup.style.display = 'block';
            } else if (productType === 'booklet') {
                document.body.classList.add('booklet-selected');
                const quantityGroup = document.querySelector('.form-group:has(#quantity)');
                if (quantityGroup) quantityGroup.style.display = 'none';
                const visitingQuantityGroup = document.querySelector('.form-group:has(#visitingQuantity)');
                if (visitingQuantityGroup) visitingQuantityGroup.style.display = 'none';
                const bookletQuantityGroup = document.querySelector('.form-group:has(#bookletQuantity)');
                if (bookletQuantityGroup) bookletQuantityGroup.style.display = 'block';
            } else if (productType === 'book') {
                document.body.classList.add('book-selected');
                const quantityGroup = document.querySelector('.form-group:has(#quantity)');
                if (quantityGroup) quantityGroup.style.display = 'none';
                const visitingQuantityGroup = document.querySelector('.form-group:has(#visitingQuantity)');
                if (visitingQuantityGroup) visitingQuantityGroup.style.display = 'none';
                const bookletQuantityGroup = document.querySelector('.form-group:has(#bookletQuantity)');
                if (bookletQuantityGroup) bookletQuantityGroup.style.display = 'none';
            } else {
                const quantityGroup = document.querySelector('.form-group:has(#quantity)');
                if (quantityGroup) quantityGroup.style.display = 'block';
                const visitingQuantityGroup = document.querySelector('.form-group:has(#visitingQuantity)');
                if (visitingQuantityGroup) visitingQuantityGroup.style.display = 'none';
                const bookletQuantityGroup = document.querySelector('.form-group:has(#bookletQuantity)');
                if (bookletQuantityGroup) bookletQuantityGroup.style.display = 'none';
            }
            updateContainerVisibility(productType);
        }
        function updateContainerVisibility(productType) {
            const mockupContainer = document.querySelector('.mockup-container');
            const resultContainer = document.querySelector('.result-container');
            if (mockupContainer && resultContainer) {
                if (productType === 'visiting') {
                    mockupContainer.style.display = 'block';
                    document.querySelector('.result-title').textContent = 'Стоимость визиток';
                    setTimeout(() => { renderSheetLayout(24, 'visiting'); }, 10);
                } else if (productType === 'booklet') {
                    mockupContainer.style.display = 'block';
                    document.querySelector('.result-title').textContent = 'Стоимость лифлетов';
                    setTimeout(() => {
                        const product = getFormData();
                        const costResult = calculateProductCost(product);
                        renderSheetLayout(costResult.itemsPerSheet, 'booklet', product.width, product.height);
                    }, 10);
                } else if (productType === 'book') {
                    mockupContainer.style.display = 'block';
                    document.querySelector('.result-title').textContent = 'Стоимость книги';
                } else {
                    mockupContainer.style.display = 'block';
                    document.querySelector('.result-title').textContent = 'Стоимость текущего изделия';
                }
            }
        }
        // =============================================
        // ФУНКЦИИ РАСЧЕТА СТОИМОСТИ
        // =============================================
        function calculateProductCost(product) {
            switch (product.type) {
                case 'visiting': return calculateVisitingCardCost(product);
                case 'booklet': return calculateRefletCost(product);
                case 'book': return calculateBookCost(product);
                default: return calculateSheetCost(product);
            }
        }
        function calculateItemsPerSheet(width, height) {
            if (!width || !height || width <= 0 || height <= 0) return 1;
            const itemWidth = width + CUT_MARGIN;
            const itemHeight = height + CUT_MARGIN;
            if (itemWidth > SHEET_WIDTH || itemHeight > SHEET_HEIGHT) return 1;
            const horizontalCount = Math.floor(SHEET_WIDTH / itemWidth);
            const horizontalRows = Math.floor(SHEET_HEIGHT / itemHeight);
            const horizontalTotal = horizontalCount * horizontalRows;
            const verticalCount = Math.floor(SHEET_WIDTH / itemHeight);
            const verticalRows = Math.floor(SHEET_HEIGHT / itemWidth);
            const verticalTotal = verticalCount * verticalRows;
            return Math.max(horizontalTotal, verticalTotal, 1);
        }
        function calculateSheetCost(product) {
            const kras = product.kras || 1;
            const item = product.item || 1;
            const razmer = product.razmer || 2;
            const pap = product.pap || 2;
            const width = product.width || (FORMAT_SIZES[razmer] ? FORMAT_SIZES[razmer].width : 148);
            const height = product.height || (FORMAT_SIZES[razmer] ? FORMAT_SIZES[razmer].height : 210);
            let itemsPerSheet = calculateItemsPerSheet(width, height);
            const sheetsRequired = Math.ceil(item / itemsPerSheet);
            const itemsPerA = item / itemsPerSheet;
            let quantityCategory;
            const baseQuantity = 5 * itemsPerSheet;
            if (item <= baseQuantity) quantityCategory = 0;
            else if (item <= 10 * itemsPerSheet) quantityCategory = 1;
            else if (item <= 50 * itemsPerSheet) quantityCategory = 2;
            else if (item <= 100 * itemsPerSheet) quantityCategory = 3;
            else if (item <= 500 * itemsPerSheet) quantityCategory = 4;
            else quantityCategory = 5;
            let costPrintOnly = 0;
            if (kras === 1) costPrintOnly = KRAS1_PRICES[quantityCategory] * itemsPerA * DOLLARS;
            else if (kras === 2) costPrintOnly = KRAS2_PRICES[quantityCategory] * itemsPerA * DOLLARS;
            else if (kras === 3) costPrintOnly = KRAS3_PRICE * itemsPerA * DOLLARS;
            else if (kras === 4) costPrintOnly = KRAS4_PRICE * itemsPerA * DOLLARS;
            else if (kras === 5) costPrintOnly = (KRAS1_PRICES[quantityCategory] + KRAS3_PRICE) * itemsPerA * DOLLARS;
            let costPaperOnly = 0;
            if (pap >= 1 && pap <= 12) { if (!((kras === 3 || kras === 4) && pap === 1)) costPaperOnly = PAPER_PRICES[pap-1] * itemsPerA * DOLLARS; }
            const cuttingCost = ((itemsPerSheet/2) + 4) * CUTTING_PRICE_PER_HIT;
            let result = costPrintOnly + costPaperOnly + cuttingCost;
            let additionalCosts = calculateAdditionalCosts(product, sheetsRequired, item, razmer);
            result += additionalCosts.total;
            result = roundUpTo10(result);
            return {
                totalCost: result,
                costPrintOnly: costPrintOnly,
                costPaperOnly: costPaperOnly,
                itemRez: cuttingCost,
                ...additionalCosts,
                itemsPerSheet: itemsPerSheet,
                sheetsUsed: sheetsRequired
            };
        }
        function calculateAdditionalCosts(product, totalSheets, item, razmer) {
            let costs = {
                embossingCost: 0, dieCuttingCost: 0, laminationCost: 0, scoringCost: 0,
                foldingCost: 0, cornerRoundingCost: 0, numberingCost: 0, perforationCost: 0,
                gluingCost: 0, bindingCost: 0, bookletScoringCost: 0, total: 0
            };
            if (product.type === 'booklet') {
                costs.bookletScoringCost = 2 * SCORING_PRICE_PER_HIT * item * DOLLARS;
                if (product.bookletEmbossingRequired && product.bookletEmbossingHits >= 20) {
                    const pricePerHit = getPricePerHit(product.bookletEmbossingHits);
                    costs.embossingCost = (EMBOSSING_SETUP * DOLLARS) + (product.bookletEmbossingHits * pricePerHit * DOLLARS);
                }
                if (product.bookletLaminationRequired) costs.laminationCost = LAMINATION_PRICES[product.bookletLaminationType] * totalSheets * DOLLARS;
            }
            if (product.type === 'visiting') {
                if (product.visitingCornerRoundingRequired && product.visitingCornerRoundingSheets > 0) costs.cornerRoundingCost = product.visitingCornerRoundingSheets * CORNER_ROUNDING_PRICE * DOLLARS;
            }
            if (product.type === 'sheet') {
                if (product.embossingRequired && product.embossingHits >= 20) {
                    const pricePerHit = getPricePerHit(product.embossingHits);
                    costs.embossingCost = (EMBOSSING_SETUP * DOLLARS) + (product.embossingHits * pricePerHit * DOLLARS);
                }
                if (product.dieCuttingRequired && product.dieCuttingHits >= 20) {
                    const pricePerHit = getPricePerHit(product.dieCuttingHits);
                    costs.dieCuttingCost = (DIE_CUTTING_SETUP * DOLLARS) + (product.dieCuttingHits * pricePerHit * DOLLARS);
                }
                if (product.laminationRequired) costs.laminationCost = LAMINATION_PRICES[product.laminationType] * totalSheets * DOLLARS;
                if (product.scoringRequired) costs.scoringCost = product.scoringHits * SCORING_PRICE_PER_HIT * item * DOLLARS;
                if (product.foldingRequired) costs.foldingCost = product.foldingHits * FOLDING_PRICE_PER_HIT * item * DOLLARS;
                if (product.cornerRoundingRequired) costs.cornerRoundingCost = product.cornerRoundingSheets * CORNER_ROUNDING_PRICE * DOLLARS;
                if (product.numberingRequired) costs.numberingCost = product.numberingSheets * NUMBERING_PRICE * DOLLARS;
                if (product.perforationRequired) costs.perforationCost = product.perforationSheets * PERFORATION_PRICE * DOLLARS;
                if (product.gluingRequired && (razmer === 2 || razmer === 3)) costs.gluingCost = GLUING_PRICES[razmer] * product.gluingSheets * DOLLARS;
                if (product.bindingRequired) {
                    if (product.bindingType === 'spiral' && (razmer === 1 || razmer === 2)) costs.bindingCost = getBindingPrice(product.bindingSheets, razmer, product.bindingWithCover) * product.bindingCount * DOLLARS;
                    else if (product.bindingType === 'staple') costs.bindingCost = (product.stapleBindingCount || product.bindingCount) * 25;
                }
            }
            costs.total = Object.values(costs).reduce((sum, cost) => sum + (typeof cost === 'number' ? cost : 0), 0);
            return costs;
        }
        function calculateVisitingCardCost(product) {
            let kras = product.kras || 1;
            let item = product.item || 96;
            const pap = product.pap || 10;
            if (item % 24 !== 0) item = Math.ceil(item / 24) * 24;
            let categoryIndex = 3;
            if (item >= 96 && item <= 311) categoryIndex = 0;
            else if (item >= 312 && item <= 499) categoryIndex = 1;
            else if (item >= 500 && item <= 959) categoryIndex = 2;
            const priceKey = `${kras}_${pap}`;
            let pricePerItem = VISITING_CARD_PRICES[priceKey]?.[categoryIndex] || 0;
            if (product.visitingLaminationRequired && product.visitingLaminationType && pap === 10) {
                if (product.visitingLaminationType == 1) pricePerItem = VISITING_CARD_PRICES_MATTE_LAMINATION[priceKey]?.[categoryIndex] || pricePerItem;
                else if (product.visitingLaminationType == 2) pricePerItem = VISITING_CARD_PRICES_SOFT_TOUCH_LAMINATION[priceKey]?.[categoryIndex] || pricePerItem;
            }
            let totalCost = pricePerItem * item;
            const totalSheets = Math.ceil(item / 24);
            let visitingCornerRoundingCost = 0;
            if (product.visitingCornerRoundingRequired && product.visitingCornerRoundingSheets > 0) {
                visitingCornerRoundingCost = product.visitingCornerRoundingSheets * CORNER_ROUNDING_PRICE * DOLLARS;
                totalCost += visitingCornerRoundingCost;
            }
            totalCost = roundUpTo10(totalCost);
            return {
                totalCost: totalCost,
                costPrintOnly: pricePerItem * item,
                costPaperOnly: 0,
                itemRez: 0,
                laminationCost: 0,
                cornerRoundingCost: visitingCornerRoundingCost,
                itemsPerSheet: 24,
                sheetsUsed: totalSheets
            };
        }
        function calculateRefletCost(product) {
            const kras = product.kras || 2;
            const item = product.item || 100;
            const pap = product.pap || 2;
            const bookletSize = product.bookletSize || 'A4';
            let width, height, itemsPerSheet;
            if (bookletSize === 'A3') { width = 297; height = 420; itemsPerSheet = 1; product.razmer = 1; } 
            else { width = 210; height = 297; itemsPerSheet = 2; product.razmer = 2; }
            const sheetsRequired = Math.ceil(item / itemsPerSheet);
            const itemsPerA = item / itemsPerSheet;
            let quantityCategory;
            const baseQuantity = 5 * itemsPerSheet;
            if (item <= baseQuantity) quantityCategory = 0;
            else if (item <= 10 * itemsPerSheet) quantityCategory = 1;
            else if (item <= 50 * itemsPerSheet) quantityCategory = 2;
            else if (item <= 100 * itemsPerSheet) quantityCategory = 3;
            else if (item <= 500 * itemsPerSheet) quantityCategory = 4;
            else quantityCategory = 5;
            let costPrintOnly = 0;
            if (kras === 1) costPrintOnly = KRAS1_PRICES[quantityCategory] * itemsPerA * DOLLARS;
            else if (kras === 2) costPrintOnly = KRAS2_PRICES[quantityCategory] * itemsPerA * DOLLARS;
            else if (kras === 3) costPrintOnly = KRAS3_PRICE * itemsPerA * DOLLARS;
            else if (kras === 4) costPrintOnly = KRAS4_PRICE * itemsPerA * DOLLARS;
            else if (kras === 5) costPrintOnly = (KRAS1_PRICES[quantityCategory] + KRAS3_PRICE) * itemsPerA * DOLLARS;
            let costPaperOnly = 0;
            if (pap >= 1 && pap <= 12) { if (!((kras === 3 || kras === 4) && pap === 1)) costPaperOnly = PAPER_PRICES[pap-1] * itemsPerA * DOLLARS; }
            const cuttingCost = ((itemsPerSheet/2) + 4) * CUTTING_PRICE_PER_HIT;
            let result = costPrintOnly + costPaperOnly + cuttingCost;
            let additionalCosts = calculateAdditionalCosts(product, sheetsRequired, item, product.razmer);
            result += additionalCosts.total;
            result = roundUpTo10(result);
            return {
                totalCost: result,
                costPrintOnly: costPrintOnly,
                costPaperOnly: costPaperOnly,
                itemRez: cuttingCost,
                ...additionalCosts,
                itemsPerSheet: itemsPerSheet,
                sheetsUsed: sheetsRequired
            };
        }
        // =============================================
        // ФУНКЦИИ ОТОБРАЖЕНИЯ РЕЗУЛЬТАТОВ
        // =============================================
        function displayCostResults(costResult, product) {
            if (!costResult) return;
            let totalCost = costResult.totalCost < MINIMAL_ORDER_COST ? MINIMAL_ORDER_COST : costResult.totalCost;
            document.getElementById('currentCostValue').textContent = `${totalCost.toFixed(2)} руб.`;
            document.getElementById('minimalCostNote').style.display = costResult.totalCost < MINIMAL_ORDER_COST ? 'block' : 'none';
            const saveButton = document.getElementById('saveProductBtn');
            if (saveButton) saveButton.setAttribute('data-tooltip', `Стоимость: ${totalCost.toFixed(2)} руб.`);
            switch (product.type) {
                case 'visiting': displayVisitingCardResults(costResult); break;
                case 'booklet': displayRefletResults(costResult); break;
                case 'book': displayBookResults(costResult, product); break; // Передаем product для проверки чекбокса
                default: displaySheetResults(costResult);
            }
            if (product.type !== 'book') renderSheetLayout(costResult.itemsPerSheet, product.type, product.width, product.height);
        }
        function resetCostDisplay() {
            const costItems = [
                'embossingCostItem', 'dieCuttingCostItem', 'laminationCostItem', 
                'scoringCostItem', 'foldingCostItem', 'cornerRoundingCostItem', 
                'numberingCostItem', 'perforationCostItem', 'gluingCostItem', 
                'bindingCostItem', 'bookletScoringCostItem', 'bookBodyCostItem', 
                'bookCoverCostItem', 'bookBindingCostItem'
            ];
            costItems.forEach(itemId => {
                const element = document.getElementById(itemId);
                if (element) element.style.display = 'none';
            });
            document.getElementById('colorCost').textContent = '0 руб.';
            document.getElementById('paperCost').textContent = '0 руб.';
            document.getElementById('cuttingCost').textContent = '0 руб.';
            document.getElementById('itemsPerSheet').textContent = '0';
            document.getElementById('sheetsUsed').textContent = '0';
        }
        function displaySheetResults(costResult) {
            if (!costResult) return;
            document.getElementById('colorCost').textContent = `${costResult.costPrintOnly.toFixed(2)} руб.`;
            document.getElementById('paperCost').textContent = `${costResult.costPaperOnly.toFixed(2)} руб.`;
            document.getElementById('cuttingCost').textContent = `${costResult.itemRez.toFixed(2)} руб.`;
            const elements = {
                'embossingCost': costResult.embossingCost, 'dieCuttingCost': costResult.dieCuttingCost,
                'laminationCost': costResult.laminationCost, 'scoringCost': costResult.scoringCost,
                'foldingCost': costResult.foldingCost, 'cornerRoundingCost': costResult.cornerRoundingCost,
                'numberingCost': costResult.numberingCost, 'perforationCost': costResult.perforationCost,
                'gluingCost': costResult.gluingCost, 'bindingCost': costResult.bindingCost
            };
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                const itemElement = document.getElementById(id + 'Item');
                if (element && itemElement) {
                    element.textContent = `${value.toFixed(2)} руб.`;
                    itemElement.style.display = value > 0 ? 'flex' : 'none';
                }
            });
            document.getElementById('itemsPerSheet').textContent = costResult.itemsPerSheet;
            document.getElementById('sheetsUsed').textContent = costResult.sheetsUsed;
        }
        function displayVisitingCardResults(costResult) {
            if (!costResult) return;
            document.getElementById('colorCost').textContent = `${costResult.costPrintOnly.toFixed(2)} руб.`;
            document.getElementById('paperCost').textContent = '0 руб.';
            document.getElementById('cuttingCost').textContent = '0 руб.';
            if (costResult.cornerRoundingCost > 0) {
                document.getElementById('cornerRoundingCost').textContent = `${costResult.cornerRoundingCost.toFixed(2)} руб.`;
                document.getElementById('cornerRoundingCostItem').style.display = 'flex';
            } else document.getElementById('cornerRoundingCostItem').style.display = 'none';
            document.getElementById('itemsPerSheet').textContent = '24';
            document.getElementById('sheetsUsed').textContent = costResult.sheetsUsed;
        }
        function displayRefletResults(costResult) {
            if (!costResult) return;
            document.getElementById('colorCost').textContent = `${costResult.costPrintOnly.toFixed(2)} руб.`;
            document.getElementById('paperCost').textContent = `${costResult.costPaperOnly.toFixed(2)} руб.`;
            document.getElementById('cuttingCost').textContent = `${costResult.itemRez.toFixed(2)} руб.`;
            document.getElementById('bookletScoringCost').textContent = `${costResult.bookletScoringCost.toFixed(2)} руб.`;
            document.getElementById('bookletScoringCostItem').style.display = 'flex';
            const elements = { 'embossingCost': costResult.embossingCost, 'laminationCost': costResult.laminationCost };
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                const itemElement = document.getElementById(id + 'Item');
                if (element && itemElement) {
                    element.textContent = `${value.toFixed(2)} руб.`;
                    itemElement.style.display = value > 0 ? 'flex' : 'none';
                }
            });
            document.getElementById('itemsPerSheet').textContent = costResult.itemsPerSheet;
            document.getElementById('sheetsUsed').textContent = costResult.sheetsUsed;
        }
        // =============================================
        // ФУНКЦИИ РАБОТЫ С ИЗДЕЛИЯМИ
        // =============================================
        function addProduct() {
            const product = getFormData();
            if (isDuplicateProduct(product)) { showDuplicateModal(product); return; }
            saveProduct(product);
        }
        function saveProduct(product) {
            if (currentProductId) {
                const index = products.findIndex(p => p.id === currentProductId);
                if (index !== -1) products[index] = product;
            } else {
                products.push(product);
                const productType = product.type;
                productCounter[productType] = (productCounter[productType] || 1) + 1;
                saveProductCounterToStorage();
            }
            saveProductsToStorage();
            resetForm();
            renderProductsList();
            const totalCost = updateTotalCost();
            showNotification(`${totalCost.toFixed(2)} руб.`, true);
        }
        function editProduct(index) {
            if (index >= 0 && index < products.length) {
                const product = products[index];
                fillForm(product);
                document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
            }
        }
        function deleteProduct(index) {
            if (index >= 0 && index < products.length) {
                products.splice(index, 1);
                saveProductsToStorage();
                renderProductsList();
                const totalCost = updateTotalCost();
                showNotification(`${totalCost.toFixed(2)} руб.`, true);
            }
        }
        function renderProductsList() {
            const productsList = document.getElementById('productsList');
            if (!productsList) return;
            if (products.length === 0) {
                productsList.innerHTML = '<div class="empty-list-message">Добавьте первое изделие</div>';
                return;
            }
            productsList.innerHTML = '';
            products.forEach((product, index) => {
                const costResult = calculateProductCost(product);
                const totalCost = costResult.totalCost < MINIMAL_ORDER_COST ? MINIMAL_ORDER_COST : costResult.totalCost;
                const productElement = document.createElement('div');
                productElement.className = 'product-item';
                if (product.type === 'book') {
                    productElement.innerHTML = `
                        <div class="product-summary">
                            <div class="product-info">
                                <div class="product-name">${product.name} <span class="product-type-badge">${getProductTypeName(product.type)}</span></div>
                                <div class="product-basic-details">${getProductDetails(product)}</div>
                            </div>
                            <div class="product-cost">${totalCost.toFixed(2)} руб.</div>
                            <div class="product-actions">
                                <button class="action-btn edit-btn edit-button" data-index="${index}">
                                    <svg class="edit-svgIcon" viewBox="0 0 512 512"><path d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1v32c0 8.8 7.2 16 16 16h32zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z"></path></svg>
                                </button>
                                <button class="action-btn delete-btn button" data-index="${index}">
                                    <svg class="svgIcon" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="product-details">
                            ${costResult.bodyCost > 0 ? `<div class="detail-row"><span class="detail-label">Блок книги:</span><span class="detail-value">${costResult.bodyCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.coverCost > 0 ? 
                                `<div class="detail-row"><span class="detail-label">Обложка:</span><span class="detail-value">${costResult.coverCost.toFixed(2)} руб.</span></div>` : 
                                (product.bookCoverNotRequired ? 
                                    `<div class="detail-row"><span class="detail-label">Обложка:</span><span class="detail-value">нет</span></div>` : 
                                    '')
                            }
                            ${costResult.bindingCost > 0 ? `<div class="detail-row"><span class="detail-label">Переплет книги:</span><span class="detail-value">${costResult.bindingCost.toFixed(2)} руб.</span></div>` : ''}
                        </div>
                    `;
                } else {
                    productElement.innerHTML = `
                        <div class="product-summary">
                            <div class="product-info">
                                <div class="product-name">${product.name} <span class="product-type-badge">${getProductTypeName(product.type)}</span></div>
                                <div class="product-basic-details">${getProductDetails(product)}</div>
                            </div>
                            <div class="product-cost">${totalCost.toFixed(2)} руб.</div>
                            <div class="product-actions">
                                <button class="action-btn edit-btn edit-button" data-index="${index}">
                                    <svg class="edit-svgIcon" viewBox="0 0 512 512"><path d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1v32c0 8.8 7.2 16 16 16h32zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z"></path></svg>
                                </button>
                                <button class="action-btn delete-btn button" data-index="${index}">
                                    <svg class="svgIcon" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"></path></svg>
                                </button>
                            </div>
                        </div>
                        <div class="product-details">
                            <div class="detail-row"><span class="detail-label">Печать:</span><span class="detail-value">${costResult.costPrintOnly.toFixed(2)} руб.</span></div>
                            <div class="detail-row"><span class="detail-label">Бумага:</span><span class="detail-value">${costResult.costPaperOnly.toFixed(2)} руб.</span></div>
                            <div class="detail-row"><span class="detail-label">Резка:</span><span class="detail-value">${costResult.itemRez.toFixed(2)} руб.</span></div>
                            ${costResult.bookletScoringCost > 0 ? `<div class="detail-row"><span class="detail-label">Биговка лифлетов:</span><span class="detail-value">${costResult.bookletScoringCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.embossingCost > 0 ? `<div class="detail-row"><span class="detail-label">Тиснение:</span><span class="detail-value">${costResult.embossingCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.dieCuttingCost > 0 ? `<div class="detail-row"><span class="detail-label">Вырубка:</span><span class="detail-value">${costResult.dieCuttingCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.laminationCost > 0 ? `<div class="detail-row"><span class="detail-label">Ламинация:</span><span class="detail-value">${costResult.laminationCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.scoringCost > 0 ? `<div class="detail-row"><span class="detail-label">Биговка:</span><span class="detail-value">${costResult.scoringCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.foldingCost > 0 ? `<div class="detail-row"><span class="detail-label">Фальцовка:</span><span class="detail-value">${costResult.foldingCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.cornerRoundingCost > 0 ? `<div class="detail-row"><span class="detail-label">Скругление углов:</span><span class="detail-value">${costResult.cornerRoundingCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.numberingCost > 0 ? `<div class="detail-row"><span class="detail-label">Нумерация:</span><span class="detail-value">${costResult.numberingCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.perforationCost > 0 ? `<div class="detail-row"><span class="detail-label">Перфорация:</span><span class="detail-value">${costResult.perforationCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.gluingCost > 0 ? `<div class="detail-row"><span class="detail-label">Склейка:</span><span class="detail-value">${costResult.gluingCost.toFixed(2)} руб.</span></div>` : ''}
                            ${costResult.bindingCost > 0 ? `<div class="detail-row"><span class="detail-label">Переплет:</span><span class="detail-value">${costResult.bindingCost.toFixed(2)} руб.</span></div>` : ''}
                        </div>
                    `;
                }
                const editBtn = productElement.querySelector('.edit-btn');
                const deleteBtn = productElement.querySelector('.delete-btn');
                editBtn.addEventListener('click', (e) => { e.stopPropagation(); editProduct(index); });
                deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); deleteProduct(index); });
                productsList.appendChild(productElement);
            });
        }
        function getProductDetails(product) {
            let details = '';
            switch (product.type) {
                case 'visiting': details = `Визитки, ${product.item} шт., ${getColorTypeName(product.kras)}, ${getPaperName(product.pap)}`; break;
                case 'booklet': details = `Лифлеты ${product.bookletSize}, ${product.item} шт., ${getColorTypeName(product.kras)}, ${getPaperName(product.pap)}`; break;
                case 'book': 
                    const coverInfo = product.bookCoverNotRequired ? 'без обложки' : 'с обложкой';
                    details = `Книга, тираж ${product.bookQuantity} шт., ${getFormatName(product.bookBodyFormat)}, ${product.bookBodySheets} л., ${getColorTypeName(product.bookBodyColorType)}, ${coverInfo}`; 
                    break;
                default: details = `${getFormatName(product.razmer)}, ${product.item} шт., ${getColorTypeName(product.kras)}, ${getPaperName(product.pap)}`;
            }
            return details;
        }
        function isDuplicateProduct(newProduct) {
            return products.some(product => 
                product.type === newProduct.type &&
                product.kras === newProduct.kras &&
                product.item === newProduct.item &&
                product.razmer === newProduct.razmer &&
                product.pap === newProduct.pap &&
                (product.type !== 'booklet' || product.bookletSize === newProduct.bookletSize) &&
                (product.type !== 'book' || (
                    product.bookQuantity === newProduct.bookQuantity &&
                    product.bookBodyColorType === newProduct.bookBodyColorType &&
                    product.bookBodyFormat === newProduct.bookBodyFormat &&
                    product.bookBodySheets === newProduct.bookBodySheets &&
                    product.bookBodyPaperType === newProduct.bookBodyPaperType &&
                    product.bookCoverNotRequired === newProduct.bookCoverNotRequired &&
                    product.bookCoverColorType === newProduct.bookCoverColorType &&
                    product.bookCoverPaperType === newProduct.bookCoverPaperType &&
                    product.bookCoverLaminationType === newProduct.bookCoverLaminationType &&
                    product.bookBindingType === newProduct.bookBindingType
                ))
            );
        }
        // =============================================
        // ФУНКЦИИ ИНТЕРФЕЙСА И ВАЛИДАЦИИ
        // =============================================
        function setupAllButtons() {
            const allButtons = {
                'embossingAllButton': 'embossingHits', 'dieCuttingAllButton': 'dieCuttingHits',
                'cornerRoundingAllButton': 'cornerRoundingSheets', 'numberingAllButton': 'numberingSheets',
                'perforationAllButton': 'perforationSheets', 'gluingAllButton': 'gluingSheets',
                'visitingCornerRoundingAllButton': 'visitingCornerRoundingSheets', 'bookletEmbossingAllButton': 'bookletEmbossingHits'
            };
            Object.entries(allButtons).forEach(([buttonId, inputId]) => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.addEventListener('click', function() {
                        const productType = document.getElementById('productType').value;
                        const quantityField = productType === 'visiting' ? 'visitingQuantity' : 
                                            productType === 'booklet' ? 'bookletQuantity' : 'quantity';
                        const quantity = parseInt(document.getElementById(quantityField).value) || 0;
                        if (inputId.includes('Hits') && quantity < 20) {
                            showNotification("Количество листов меньше 20. Значение не изменено.");
                            return;
                        }
                        const input = document.getElementById(inputId);
                        if (input) { input.value = quantity; calculateCost(); }
                    });
                }
            });
        }
        function setupVisitingQuantityControl() {
            const minusBtn = document.getElementById('visitingQuantityMinus');
            const plusBtn = document.getElementById('visitingQuantityPlus');
            const quantityInput = document.getElementById('visitingQuantity');
            if (minusBtn) minusBtn.addEventListener('click', function() {
                let currentValue = parseInt(quantityInput.value) || 96;
                if (currentValue > 96) { quantityInput.value = Math.max(96, currentValue - 24); calculateCost(); }
            });
            if (plusBtn) plusBtn.addEventListener('click', function() {
                let currentValue = parseInt(quantityInput.value) || 96;
                quantityInput.value = currentValue + 24; calculateCost();
            });
            if (quantityInput) {
                quantityInput.addEventListener('change', function() {
                    let value = parseInt(this.value) || 96;
                    if (value < 96) value = 96;
                    value = Math.max(96, Math.ceil(value / 24) * 24);
                    this.value = value; calculateCost();
                });
                quantityInput.addEventListener('input', function() {
                    let value = parseInt(this.value) || 96;
                    if (value < 96) value = 96;
                });
                quantityInput.addEventListener('blur', function() {
                    let value = parseInt(this.value) || 96;
                    if (value < 96) value = 96;
                    value = Math.max(96, Math.ceil(value / 24) * 24);
                    this.value = value; calculateCost();
                });
            }
        }
        function checkBindingAvailability() {
            const bindingRequired = document.getElementById('bindingRequired');
            if (!bindingRequired) return;
            const bindingType = document.getElementById('bindingType') ? document.getElementById('bindingType').value : 'staple';
            const format = parseInt(document.getElementById('formatType').value);
            if (bindingRequired.checked && bindingType === 'spiral' && format !== 1 && format !== 2) {
                showNotification("Переплет пружиной доступен только для форматов А3 и А4!");
                if (document.getElementById('bindingType')) document.getElementById('bindingType').value = 'staple';
                const spiralOptions = document.getElementById('spiralOptions');
                const stapleOptions = document.getElementById('stapleOptions');
                if (spiralOptions) spiralOptions.style.display = 'none';
                if (stapleOptions) stapleOptions.style.display = 'block';
            }
        }
        function checkGluingAvailability() {
            const format = parseInt(document.getElementById('formatType').value);
            const gluingCheckbox = document.getElementById('gluingRequired');
            if (gluingCheckbox) {
                if (format !== 2 && format !== 3) {
                    if (gluingCheckbox.checked) {
                        gluingCheckbox.checked = false;
                        const gluingOptions = document.getElementById('gluingOptions');
                        if (gluingOptions) gluingOptions.style.display = 'none';
                        showNotification("Склейка доступна только для форматов А4 и А5!");
                    }
                    gluingCheckbox.disabled = true;
                    gluingCheckbox.parentElement.style.opacity = '0.5';
                } else {
                    gluingCheckbox.disabled = false;
                    gluingCheckbox.parentElement.style.opacity = '1';
                }
            }
        }
        // =============================================
        // ФУНКЦИИ ОТОБРАЖЕНИЯ И УВЕДОМЛЕНИЙ
        // =============================================
        function renderSheetLayout(itemsPerSheet, productType, width = null, height = null) {
            const sheet = document.getElementById('a3Sheet');
            if (!sheet) return;
            sheet.innerHTML = '';
            sheet.style.width = '60%';
            sheet.style.height = 'auto';
            sheet.style.aspectRatio = '297/420';
            if ((!width || !height) && productType !== 'visiting' && productType !== 'booklet') {
                width = parseInt(document.getElementById('width').value) || 297;
                height = parseInt(document.getElementById('height').value) || 210;
            }
            if (productType === 'visiting') {
                const layout = document.createElement('div');
                layout.className = 'visiting-card-layout';
                for (let i = 0; i < 24; i++) {
                    const card = document.createElement('div');
                    card.className = 'visiting-card-item';
                    card.title = `Визитка ${i+1}`;
                    const cardText = document.createElement('div');
                    cardText.className = 'visiting-card-size';
                    cardText.textContent = '50×90 мм';
                    card.appendChild(cardText);
                    layout.appendChild(card);
                }
                sheet.appendChild(layout);
            } else if (productType === 'booklet') {
                const bookletSize = document.querySelector('input[name="bookletSize"]:checked').value;
                if (bookletSize === 'A3') {
                    const layout = document.createElement('div');
                    layout.style.cssText = `width: 100%; height: 100%; display: flex; position: relative;`;
                    const booklet = document.createElement('div');
                    booklet.className = 'item-on-sheet';
                    booklet.style.cssText = `width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; box-sizing: border-box; border: 2px solid var(--dark); background: rgba(110, 189, 82, 0.2); position: relative;`;
                    const bookletText = document.createElement('div');
                    bookletText.className = 'item-outline';
                    bookletText.style.cssText = `color: var(--dark); font-weight: 700; text-align: center; font-size: 14px; transform: rotate(0deg); text-shadow: 0 0 2px rgba(255,255,255,0.8);`;
                    bookletText.textContent = 'Лифлет А3';
                    booklet.appendChild(bookletText);
                    const foldLine1 = document.createElement('div'); foldLine1.className = 'fold-line-horizontal'; foldLine1.style.top = '33%';
                    const foldLine2 = document.createElement('div'); foldLine2.className = 'fold-line-horizontal'; foldLine2.style.top = '66%';
                    booklet.appendChild(foldLine1); booklet.appendChild(foldLine2);
                    layout.appendChild(booklet); sheet.appendChild(layout);
                } else {
                    const layout = document.createElement('div');
                    layout.style.cssText = `width: 100%; height: 100%; display: flex; flex-direction: column; position: relative;`;
                    for (let i = 0; i < Math.min(itemsPerSheet, 2); i++) {
                        const booklet = document.createElement('div');
                        booklet.className = 'item-on-sheet';
                        booklet.style.cssText = `width: 100%; height: 50%; display: flex; align-items: center; justify-content: center; box-sizing: border-box; border: 2px solid var(--dark); background: rgba(110, 189, 82, 0.2); position: relative;`;
                        const bookletText = document.createElement('div');
                        bookletText.className = 'item-outline';
                        bookletText.style.cssText = `color: var(--dark); font-weight: 700; text-align: center; font-size: 14px; transform: rotate(0deg); text-shadow: 0 0 2px rgba(255,255,255,0.8);`;
                        bookletText.textContent = 'Лифлет А4';
                        booklet.appendChild(bookletText);
                        const foldLine1 = document.createElement('div'); foldLine1.className = 'fold-line-vertical'; foldLine1.style.left = '33%';
                        const foldLine2 = document.createElement('div'); foldLine2.className = 'fold-line-vertical'; foldLine2.style.left = '66%';
                        booklet.appendChild(foldLine1); booklet.appendChild(foldLine2);
                        layout.appendChild(booklet);
                    }
                    sheet.appendChild(layout);
                }
            } else {
                let cols, rows;
                if (itemsPerSheet <= 1) { cols = 1; rows = 1; } 
                else {
                    const itemWidth = width + CUT_MARGIN; const itemHeight = height + CUT_MARGIN;
                    const horizontalCols = Math.floor(SHEET_WIDTH / itemWidth); const horizontalRows = Math.floor(SHEET_HEIGHT / itemHeight); const horizontalTotal = horizontalCols * horizontalRows;
                    const verticalCols = Math.floor(SHEET_WIDTH / itemHeight); const verticalRows = Math.floor(SHEET_HEIGHT / itemWidth); const verticalTotal = verticalCols * verticalRows;
                    if (horizontalTotal >= verticalTotal) { cols = horizontalCols; rows = horizontalRows; } 
                    else { cols = verticalCols; rows = verticalRows; }
                    const maxItems = cols * rows;
                    if (maxItems < itemsPerSheet) itemsPerSheet = maxItems;
                }
                const itemsToShow = Math.min(itemsPerSheet, 32);
                if (itemsToShow <= 0) return;
                const itemWidthPercent = 100 / cols; const itemHeightPercent = 100 / rows;
                let formatName = 'Кастомный';
                const formatSelect = document.getElementById('formatType');
                if (formatSelect && formatSelect.selectedIndex >= 0 && formatSelect.value) formatName = formatSelect.options[formatSelect.selectedIndex].text.split(' ')[0];
                else formatName = `${width}×${height} мм`;
                for (let i = 0; i < itemsToShow; i++) {
                    const row = Math.floor(i / cols); const col = i % cols;
                    const item = document.createElement('div');
                    item.className = 'item-on-sheet';
                    item.style.cssText = `position: absolute; width: ${itemWidthPercent}%; height: ${itemHeightPercent}%; top: ${row * itemHeightPercent}%; left: ${col * itemWidthPercent}%; display: flex; align-items: center; justify-content: center; box-sizing: border-box; border: 2px solid color(black); background: rgba(110, 189, 82, 0.2); border-radius: 4px;`;
                    const formatText = document.createElement('div');
                    formatText.className = 'item-outline';
                    formatText.style.cssText = `color: var(--dark); font-weight: 700; text-align: center; text-shadow: 0 0 2px rgba(255,255,255,0.8); line-height: 1.1; padding: 2px;`;
                    if (itemsToShow <= 4) formatText.style.fontSize = '14px';
                    else if (itemsToShow <= 8) formatText.style.fontSize = '12px';
                    else if (itemsToShow <= 16) formatText.style.fontSize = '10px';
                    else formatText.style.fontSize = '8px';
                    formatText.textContent = formatName;
                    item.appendChild(formatText);
                    item.title = `Размер: ${width}×${height} мм`;
                    sheet.appendChild(item);
                }
                const sizeDisplay = document.createElement('div');
                sizeDisplay.className = 'size-display';
                if (formatSelect && !formatSelect.value) sizeDisplay.classList.add('custom-size');
                sizeDisplay.textContent = `${itemsPerSheet} шт. на листе`;
                sheet.appendChild(sizeDisplay);
            }
        }
        function showNotification(message, isTotalCost = false) {
            const notification = document.getElementById('notification');
            if (!notification) return;
            const notificationIcon = notification.querySelector('.notification-icon');
            const notificationTitle = notification.querySelector('.notification-title');
            const notificationText = notification.querySelector('#notificationCost');
            if (isTotalCost) {
                notificationIcon.innerHTML = '<i class="fas fa-shopping-cart"></i>';
                notificationTitle.textContent = 'Общая стоимость заказа';
            } else {
                notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
                notificationTitle.textContent = 'Стоимость пересчитана';
            }
            notificationText.textContent = message;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 5000);
        }
        function showDuplicateModal(product) {
            const modal = document.getElementById('duplicateModal');
            if (!modal) return;
            modal.style.display = 'flex';
            document.getElementById('modalCancel').onclick = function() { modal.style.display = 'none'; };
            document.getElementById('modalConfirm').onclick = function() { modal.style.display = 'none'; saveProduct(product); };
        }
        function checkVisitingCardSuggestion() {
            const width = parseInt(document.getElementById('width').value) || 0;
            const height = parseInt(document.getElementById('height').value) || 0;
            const productType = document.getElementById('productType').value;
            const isVisitingCardSize = (width === 90 && height === 50) || (width === 50 && height === 90);
            if (isVisitingCardSize && productType === 'sheet') showVisitingCardSuggestion();
        }
        function showVisitingCardSuggestion() {
            const modal = document.getElementById('visitingCardSuggestionModal');
            if (!modal) return;
            modal.style.display = 'flex';
            document.getElementById('visitingSuggestionCancel').onclick = function() { modal.style.display = 'none'; };
            document.getElementById('visitingSuggestionConfirm').onclick = function() {
                const currentQuantity = parseInt(document.getElementById('quantity').value) || 100;
                let visitingQuantity = Math.max(96, Math.ceil(currentQuantity / 24) * 24);
                document.getElementById('productType').value = 'visiting';
                updateProductName('visiting');
                toggleFieldsVisibility('visiting');
                updateVisibility();
                document.getElementById('visitingQuantity').value = visitingQuantity;
                calculateCost();
                modal.style.display = 'none';
                showNotification(`Переключено на визитки. Количество: ${visitingQuantity} шт.`);
            };
        }
        // =============================================
        // ОСНОВНЫЕ ФУНКЦИИ РАСЧЕТА И ОБНОВЛЕНИЯ
        // =============================================
        function calculateCost() {
            try {
                resetCostDisplay();
                const product = getFormData();
                const costResult = calculateProductCost(product);
                displayCostResults(costResult, product);
                updateTotalCost();
                if (product.type !== 'book') {
                    let width, height;
                    if (product.type === 'booklet') {
                        const bookletSize = product.bookletSize || 'A4';
                        if (bookletSize === 'A3') { width = 297; height = 420; } 
                        else { width = 210; height = 297; }
                    } else if (product.type === 'visiting') { width = 50; height = 90; } 
                    else {
                        width = product.width || (FORMAT_SIZES[product.razmer] ? FORMAT_SIZES[product.razmer].width : 148);
                        height = product.height || (FORMAT_SIZES[product.razmer] ? FORMAT_SIZES[product.razmer].height : 210);
                    }
                    renderSheetLayout(costResult.itemsPerSheet, product.type, width, height);
                }
            } catch (error) {
                console.error('Ошибка расчета стоимости:', error);
                document.getElementById('currentCostValue').textContent = 'Ошибка расчета';
            }
        }
        function updateTotalCost() {
            let totalCost = products.reduce((sum, product) => {
                const costResult = calculateProductCost(product);
                return sum + (costResult.totalCost < MINIMAL_ORDER_COST ? MINIMAL_ORDER_COST : costResult.totalCost);
            }, 0);
            document.getElementById('totalOrderCost').textContent = `${totalCost.toFixed(2)} руб.`;
            return totalCost;
        }
        function resetForm() {
            document.getElementById('productId').value = '';
            const productType = document.getElementById('productType').value;
            document.getElementById('productName').value = `${getProductTypeName(productType)} ${productCounter[productType] || 1}`;
            if (productType === 'visiting') {
                document.getElementById('visitingColorType').value = '1';
                document.getElementById('visitingQuantity').value = '96';
                document.getElementById('visitingPaperType').value = '10';
                document.getElementById('visitingCornerRoundingRequired').checked = false;
                document.getElementById('visitingCornerRoundingSheets').value = '0';
                document.getElementById('visitingLaminationRequired').checked = false;
                document.getElementById('visitingLaminationType').value = '1';
            } else if (productType === 'booklet') {
                document.getElementById('bookletColorType').value = '2';
                document.getElementById('bookletQuantity').value = '100';
                document.getElementById('bookletPaperType').value = '2';
                document.querySelector('input[name="bookletSize"][value="A4"]').checked = true;
                document.getElementById('bookletEmbossingRequired').checked = false;
                document.getElementById('bookletEmbossingHits').value = '0';
                document.getElementById('bookletLaminationRequired').checked = false;
                document.getElementById('bookletLaminationType').value = '1';
            } else if (productType === 'book') {
               document.getElementById('bookQuantity').value = '10';
                document.getElementById('bookBodyColorType').value = '4';
                document.getElementById('bookBodyFormat').value = '2';
                document.getElementById('bookBodySheets').value = '5';
                document.getElementById('bookBodyPaperType').value = '1';
                document.getElementById('bookCoverNotRequired').checked = false;
                document.getElementById('bookCoverColorType').value = '4';
                document.getElementById('bookCoverPaperType').value = '2'; // 115 г/м² по умолчанию
                document.getElementById('bookCoverLaminationType').value = '0'; // Нет ламинации по умолчанию
                document.getElementById('bookBindingType').value = 'staple'; // Скрепка по умолчанию
                const coverOptions = document.getElementById('bookCoverOptions');
                if (coverOptions) {
                    coverOptions.style.opacity = '1';
                    coverOptions.style.pointerEvents = 'all';
                }
                // Скрываем сообщения об ошибках
                document.getElementById('bookQuantityError').style.display = 'none';
                document.getElementById('bookBodySheetsError').style.display = 'none';
            } else {
                document.getElementById('colorType').value = '1';
                document.getElementById('quantity').value = '1';
                document.getElementById('formatType').value = '2';
                document.getElementById('paperType').value = '2';
                document.getElementById('width').value = '210';
                document.getElementById('height').value = '297';
            }
            document.getElementById('postprintRequired').checked = false;
            const postprintOptions = ['embossing', 'dieCutting', 'lamination', 'scoring', 'folding', 'cornerRounding', 'numbering', 'perforation', 'gluing', 'binding'];
            postprintOptions.forEach(option => {
                const checkbox = document.getElementById(option + 'Required');
                if (checkbox) checkbox.checked = false;
            });
            currentProductId = null;
            updateVisibility();
            calculateCost();
            setTimeout(saveFormStateToStorage, 100);
        }
        // Добавьте новую функцию для управления доступностью типов переплета
        function updateBookBindingOptions() {
            const coverNotRequired = document.getElementById('bookCoverNotRequired').checked;
            const coverPaperType = document.getElementById('bookCoverPaperType').value;
            const bindingTypeSelect = document.getElementById('bookBindingType');
            if (!bindingTypeSelect) return;
            // Сохраняем текущее значение
            const currentValue = bindingTypeSelect.value;
            // Очищаем опции
            bindingTypeSelect.innerHTML = '';
            if (coverNotRequired) {
                // Если обложка не требуется - все типы переплета доступны
                bindingTypeSelect.innerHTML = `
                    <option value="hard">Твердый переплет</option>
                    <option value="soft">Мягкий переплет</option>
                    <option value="staple" selected>Скрепка</option>
                `;
            } else if (coverPaperType === '2') { // 115 г/м²
                // Для бумаги 115 г/м² - только твердый переплет и скрепка
                bindingTypeSelect.innerHTML = `
                    <option value="hard">Твердый переплет</option>
                    <option value="staple" selected>Скрепка</option>
                `;
            } else {
                // Для другой бумаги - только мягкий переплет и скрепка
                bindingTypeSelect.innerHTML = `
                    <option value="soft">Мягкий переплет</option>
                    <option value="staple" selected>Скрепка</option>
                `;
            }
            // Восстанавливаем предыдущее значение, если оно доступно
            if (Array.from(bindingTypeSelect.options).some(opt => opt.value === currentValue)) bindingTypeSelect.value = currentValue;
        }
        // =============================================
        // ИНИЦИАЛИЗАЦИЯ
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadProductCounterFromStorage();
            loadProductsFromStorage();
            const initialProductType = document.getElementById('productType').value;
            toggleFieldsVisibility(initialProductType);
            updateVisibility();
            setTimeout(() => { loadFormStateFromStorage(); }, 200);
            if (products.length === 0 && !localStorage.getItem(STORAGE_KEYS.FORM_STATE)) resetForm();
            setupAllButtons();
            setupVisitingQuantityControl();
            const formElementsForAutoSave = document.querySelectorAll('select, input, textarea');
            formElementsForAutoSave.forEach(element => {
                element.addEventListener('change', handleFormChange);
                element.addEventListener('input', handleFormChange);
            });
            document.getElementById('width')?.addEventListener('input', handleSizeChange);
            document.getElementById('height')?.addEventListener('input', handleSizeChange);
            document.querySelectorAll('input[name="bookletSize"]').forEach(radio => {
                radio.addEventListener('change', function() { calculateCost(); });
            });
            document.getElementById('productType')?.addEventListener('change', function() {
                const productType = this.value;
                updateProductName(productType);
                toggleFieldsVisibility(productType);
                updateVisibility();
                if (currentProductId === null) resetForm(); else calculateCost();
                setTimeout(() => {
                    const product = getFormData();
                    const costResult = calculateProductCost(product);
                    // Для книг не отображаем макет
                    if (productType !== 'book') {
                        renderSheetLayout(costResult.itemsPerSheet, productType, product.width, product.height);
                    }
                }, 10);
            });
            document.getElementById('visitingLaminationRequired')?.addEventListener('change', function() { 
                updateVisibility(); 
                calculateCost(); 
            });
            document.getElementById('visitingLaminationType')?.addEventListener('change', function() { 
                calculateCost(); 
            });
            document.getElementById('visitingPaperType')?.addEventListener('change', function() { 
                updateVisibility(); 
                calculateCost(); 
            });
            document.getElementById('visitingLaminationRequired')?.addEventListener('change', function() { 
                updateVisibility(); 
                calculateCost(); 
            });
            document.getElementById('visitingLaminationType')?.addEventListener('change', function() { 
                calculateCost(); 
            });
            document.getElementById('visitingPaperType')?.addEventListener('change', function() { 
                updateVisibility(); 
                calculateCost(); 
            });
            document.getElementById('bookCoverNotRequired')?.addEventListener('change', function() {
                const coverOptions = document.getElementById('bookCoverOptions');
                if (coverOptions) {
                    if (this.checked) {
                        coverOptions.style.opacity = '0.5';
                        coverOptions.style.pointerEvents = 'none';
                    } else {
                        coverOptions.style.opacity = '1';
                        coverOptions.style.pointerEvents = 'all';
                    }
                }
                calculateCost();
            });
            document.getElementById('bookQuantity')?.addEventListener('change', function() {
                const value = parseInt(this.value) || 10;
                const errorElement = document.getElementById('bookQuantityError');
                if (value < 10) {
                    this.value = 10;
                    if (errorElement) errorElement.style.display = 'block';
                    showNotification("Минимальный тираж книги - 10 экземпляров. Установлено значение 10.");
                } else { if (errorElement) errorElement.style.display = 'none'; }
                calculateCost();
            });
            document.getElementById('bookBodySheets')?.addEventListener('change', function() {
                const value = parseInt(this.value) || 5;
                const errorElement = document.getElementById('bookBodySheetsError');
                if (value < 5) {
                    this.value = 5;
                    if (errorElement) errorElement.style.display = 'block';
                    showNotification("Минимальное количество листов в книге - 5. Установлено значение 5.");
                } else { if (errorElement) errorElement.style.display = 'none'; }
                calculateCost();
            });
            // Обработчики для книг
            document.getElementById('bookCoverNotRequired')?.addEventListener('change', function() {
                const coverOptions = document.getElementById('bookCoverOptions');
                if (coverOptions) {
                    if (this.checked) {
                        coverOptions.style.opacity = '0.5';
                        coverOptions.style.pointerEvents = 'none';
                    } else {
                        coverOptions.style.opacity = '1';
                        coverOptions.style.pointerEvents = 'all';
                    }
                }
                updateBookBindingOptions();
                calculateCost();
            });
            document.getElementById('bookCoverPaperType')?.addEventListener('change', function() {
                updateBookBindingOptions();
                calculateCost();
            });
            // Инициализируйте состояние при загрузке
            const bookCoverNotRequired = document.getElementById('bookCoverNotRequired');
            const coverOptions = document.getElementById('bookCoverOptions');
            if (bookCoverNotRequired && coverOptions) {
                if (bookCoverNotRequired.checked) {
                    coverOptions.style.opacity = '0.5';
                    coverOptions.style.pointerEvents = 'none';
                }
            }
            // Инициализируем опции переплета при загрузке
            updateBookBindingOptions();
            document.getElementById('formatType')?.addEventListener('change', handleFormatChange);
            document.getElementById('bindingType')?.addEventListener('change', function() { updateVisibility(); calculateCost(); });
            document.getElementById('postprintRequired')?.addEventListener('change', function() { updateVisibility(); calculateCost(); });
            document.getElementById('bookletEmbossingRequired')?.addEventListener('change', function() { updateVisibility(); calculateCost(); });
            document.getElementById('bookletLaminationRequired')?.addEventListener('change', function() { updateVisibility(); calculateCost(); });
            const postprintCheckboxes = ['embossing', 'dieCutting', 'lamination', 'scoring', 'folding', 'cornerRounding', 'numbering', 'perforation', 'gluing', 'binding', 'visitingLamination', 'visitingCornerRounding'];
            postprintCheckboxes.forEach(option => {
                const checkbox = document.getElementById(option + 'Required');
                if (checkbox) checkbox.addEventListener('change', function() { updateVisibility(); calculateCost(); });
            });
            const formElementsForCalc = document.querySelectorAll('select, input[type="number"], input[type="text"]');
            formElementsForCalc.forEach(element => {
                element.addEventListener('change', calculateCost);
                element.addEventListener('input', calculateCost);
            });
            document.getElementById('saveProductBtn')?.addEventListener('click', addProduct);
            document.querySelector('.notification-close')?.addEventListener('click', function() {
                document.getElementById('notification').classList.remove('show');
            });
            document.getElementById('width')?.addEventListener('change', function() { setTimeout(checkVisitingCardSuggestion, 100); });
            document.getElementById('height')?.addEventListener('change', function() { setTimeout(checkVisitingCardSuggestion, 100); });
            calculateCost();
            renderProductsList();
            if (products.length > 0) showNotification(`Загружено ${products.length} изделий`, true);
        });
    </script>
</body>
</html>